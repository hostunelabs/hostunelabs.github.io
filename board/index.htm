<!DOCTYPE html>
<html lang=en>
<head>
<meta charset=UTF-8 />
<meta name=viewport content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>TuneBoard</title>
<link rel=preconnect href=https://fonts.googleapis.com />
<link rel=preconnect href=https://fonts.gstatic.com crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&display=swap" rel=stylesheet />
<script src=https://cdn.tailwindcss.com></script>
<script src=https://unpkg.com/lucide@latest/dist/umd/lucide.js></script>
<style>body{overscroll-behavior:none;touch-action:none;user-select:none;-webkit-user-select:none}canvas{touch-action:none;display:block}.tool-btn{transition:all .2s ease;min-height:36px;min-width:36px;display:flex;align-items:center;justify-content:center;flex-shrink:0;padding:.4rem!important}@media(max-width:640px){.tool-btn{min-height:44px;min-width:44px;padding:.5rem!important}}.tool-btn.active{background-color:#e5e7eb;color:#2563eb;transform:scale(1.05)}.color-swatch{transition:transform .2s ease;min-height:20px;min-width:20px;flex-shrink:0}@media(max-width:640px){.color-swatch{min-height:24px;min-width:24px}}.color-swatch:hover,.color-swatch.active{transform:scale(1.2);box-shadow:0 0 0 2px white,0 0 0 4px #e5e7eb}input[type="range"]{-webkit-appearance:none;appearance:none;background:transparent;height:5px;flex-shrink:0}input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;height:20px;width:20px;border-radius:50%;background:#2563eb;margin-top:-7px;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,0.1)}input[type="range"]::-moz-range-thumb{height:20px;width:20px;border-radius:50%;background:#2563eb;cursor:pointer;border:0;box-shadow:0 1px 3px rgba(0,0,0,0.1)}input[type="range"]::-webkit-slider-runnable-track{width:100%;height:5px;background:#e5e7eb;border-radius:2px}input[type="range"]::-moz-range-track{background:#e5e7eb;border-radius:2px;height:5px}.no-scrollbar::-webkit-scrollbar{display:none}.no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}#text-input{position:absolute;background:transparent;border:0;outline:0;padding:0;margin:0;font-family:"Caveat",cursive;font-weight:bold;color:black;z-index:100;min-width:50px;line-height:1}#context-menu{position:absolute;z-index:1000;background:white;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);padding:4px;min-width:160px;max-width:calc(100vw - 16px)}.context-menu-item{padding:10px 12px;font-size:14px;color:#374151;cursor:pointer;display:flex;align-items:center;gap:8px;border-radius:4px;white-space:nowrap;touch-action:manipulation;flex-shrink:0}@media(max-width:640px){.context-menu-item{padding:12px 14px;font-size:15px;min-height:44px}}.context-menu-item:hover,.context-menu-item:active{background-color:#f3f4f6;color:#111827}.color-swatch.transparent-swatch{background:repeating-conic-gradient(#ddd 0 25%,#fff 0 50%) 50% / 8px 8px;position:relative;overflow:hidden}.color-swatch.transparent-swatch::after{content:"";position:absolute;top:50%;left:-20%;width:140%;height:1px;background:red;transform:rotate(45deg)}.toolbar-main{display:flex;flex-wrap:nowrap;align-items:center;gap:1px;gap:1px;overflow:visible;max-height:56px}.toolbar-group{display:flex;align-items:center;gap:2px;padding:0 4px;flex-shrink:0;border-right:1px solid #e5e7eb}.toolbar-group:last-child{border-right:0}@media(max-width:640px){.toolbar-main{bottom:12px!important;width:calc(100% - 12px)!important;left:6px!important;transform:none!important;gap:4px!important;padding:6px 8px!important;border-radius:16px!important;max-height:70vh}.toolbar-group{gap:4px!important;padding:0 6px!important}.toolbar-group.border-r{border-right:1px solid #e5e7eb}}@media(max-width:1024px){button{min-height:44px;min-width:44px}}@media(orientation:landscape) and (max-height:600px){.toolbar-main{bottom:8px!important;max-height:90px!important}.toolbar-group{gap:2px!important}}#plus-icon-tooltip{position:absolute;z-index:1000;background:rgba(100,116,139,0.75);color:rgba(255,255,255,0.9);padding:3px 6px;border-radius:4px;font-size:10px;font-weight:400;pointer-events:none;opacity:0;transition:opacity .15s ease;white-space:nowrap}#plus-icon-tooltip.visible{opacity:1;transform:translateY(0)}#plus-icon-tooltip kbd{background:rgba(255,255,255,0.2);padding:2px 5px;border-radius:3px;font-family:ui-monospace,monospace;font-size:11px;margin-left:6px}.shape-dropdown{position:relative}.shape-dropdown-menu{position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:white;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05);padding:4px;margin-bottom:8px;min-width:120px;z-index:2000;display:none}.shape-dropdown-menu.visible{display:block}.shape-dropdown-item{padding:8px 12px;font-size:13px;color:#374151;cursor:pointer;display:flex;align-items:center;gap:8px;border-radius:4px;white-space:nowrap}.shape-dropdown-item:hover{background-color:#f3f4f6;color:#111827}.shape-dropdown-item.active{background-color:#e5e7eb;color:#2563eb}</style>
</head>
<body class="bg-gray-50 h-screen w-screen overflow-hidden flex flex-col font-sans" oncontextmenu="return false">
<img src=logo.png alt="TuneBoard Logo" class="absolute top-3 left-4 md:top-4 md:left-6 z-20 h-4 md:h-5 w-auto select-none pointer-events-none" />
<div class="toolbar-main absolute bottom-4 left-1/2 transform -translate-x-1/2 z-20 p-2 bg-white/95 backdrop-blur-md rounded-2xl shadow-xl border border-gray-200 w-[95%] max-w-6xl">
<div class=toolbar-group>
<button class="tool-btn p-2 rounded-lg text-gray-600 hover:bg-gray-100" id=btn-select onclick="setTool('select')" title="Select (S)">
<i data-lucide=mouse-pointer-2 class="w-4 h-4"></i>
</button>
<button class="tool-btn active p-2 rounded-lg text-gray-600 hover:bg-gray-100" id=btn-pencil onclick="setTool('pencil')" title="Pencil (P)">
<i data-lucide=pencil class="w-4 h-4"></i>
</button>
<button class="tool-btn p-2 rounded-lg text-gray-600 hover:bg-gray-100" id=btn-pencil-arrow onclick="setTool('pencil-arrow')" title="Freehand Arrow (F)">
<i data-lucide=trending-up class="w-4 h-4"></i>
</button>
<button class="tool-btn p-2 rounded-lg text-gray-600 hover:bg-gray-100" id=btn-laser onclick="setTool('laser')" title="Laser Tool (Z)">
<i data-lucide=zap class="w-4 h-4"></i>
</button>
<button class="tool-btn p-2 rounded-lg text-gray-600 hover:bg-gray-100" id=btn-eraser onclick="setTool('eraser')" title="Eraser (E)">
<i data-lucide=eraser class="w-4 h-4"></i>
</button>
</div>
<div class=toolbar-group>
<button class="tool-btn p-2 rounded-lg text-gray-600 hover:bg-gray-100" id=btn-line onclick="setTool('line')" title="Line (L)">
<i data-lucide=minus class="w-4 h-4 transform -rotate-45"></i>
</button>
<button class="tool-btn p-2 rounded-lg text-gray-600 hover:bg-gray-100" id=btn-arrow onclick="setTool('arrow')" title="Curved Arrow (A)">
<i data-lucide=move-up-right class="w-4 h-4"></i>
</button>
<button class="tool-btn p-2 rounded-lg text-gray-600 hover:bg-gray-100" id=btn-text onclick="setTool('text')" title="Text (T)">
<i data-lucide=type class="w-4 h-4"></i>
</button>
</div>
<div class=toolbar-group>
<button class="tool-btn p-2 rounded-lg text-gray-600 hover:bg-gray-100" id=btn-rect onclick="setTool('rect')" title="Rectangle (R)">
<i data-lucide=square class="w-4 h-4"></i>
</button>
<button class="tool-btn p-2 rounded-lg text-gray-600 hover:bg-gray-100" id=btn-circle onclick="setTool('circle')" title="Circle (C)">
<i data-lucide=circle class="w-4 h-4"></i>
</button>
<button class="tool-btn p-2 rounded-lg text-gray-600 hover:bg-gray-100" id=btn-triangle onclick="setTool('triangle')" title="Triangle (N)">
<i data-lucide=triangle class="w-4 h-4"></i>
</button>
<div class=shape-dropdown>
<button class="tool-btn p-2 rounded-lg text-gray-600 hover:bg-gray-100" id=btn-more-shapes onclick=toggleShapeDropdown() title="More Shapes">
<i data-lucide=more-horizontal class="w-4 h-4"></i>
</button>
<div id=shape-dropdown-menu class=shape-dropdown-menu>
<div class=shape-dropdown-item id=btn-oval onclick="setTool('oval');hideShapeDropdown()">
<i data-lucide=circle class="w-4 h-4"></i>
<span>Oval</span>
</div>
<div class=shape-dropdown-item id=btn-rhombus onclick="setTool('rhombus');hideShapeDropdown()">
<i data-lucide=square-round-corner class="w-4 h-4"></i>
<span>Rhombus</span>
</div>
<div class=shape-dropdown-item id=btn-diamond onclick="setTool('diamond');hideShapeDropdown()">
<i data-lucide=diamond class="w-4 h-4"></i>
<span>Diamond</span>
</div>
</div>
</div>
</div>
<div class="toolbar-group flex flex-col justify-center py-1" style=gap:2px>
<div class="flex items-center gap-1">
<button class="color-swatch w-4 h-4 rounded-full transparent-swatch border border-gray-300" onclick="setCurrentStrokeColor('transparent')" title="Stroke: Transparent"></button>
<button class="color-swatch w-4 h-4 rounded-full bg-black border border-gray-200" onclick="setCurrentStrokeColor('#000000')" title="Stroke: Black"></button>
<button class="color-swatch w-4 h-4 rounded-full bg-red-500 border border-gray-200" onclick="setCurrentStrokeColor('#ef4444')" title="Stroke: Red"></button>
<button class="color-swatch w-4 h-4 rounded-full bg-blue-500 border border-gray-200" onclick="setCurrentStrokeColor('#3b82f6')" title="Stroke: Blue"></button>
<button class="color-swatch w-4 h-4 rounded-full bg-green-500 border border-gray-200" onclick="setCurrentStrokeColor('#22c55e')" title="Stroke: Green"></button>
<div class="relative group w-4 h-4">
<input type=color class="opacity-0 absolute inset-0 w-full h-full cursor-pointer" oninput=setCurrentStrokeColor(this.value) title="Custom Stroke Color" />
<div class="w-full h-full rounded-full bg-gradient-to-br from-gray-700 to-black border border-gray-200 flex items-center justify-center">
<i data-lucide=plus class="w-2 h-2 text-white"></i>
</div>
</div>
</div>
<div class="flex items-center gap-1">
<button class="color-swatch w-4 h-4 rounded-full transparent-swatch border border-gray-300" onclick="setCurrentFillColor('transparent')" title="Fill: Transparent"></button>
<button class="color-swatch w-4 h-4 rounded-full bg-gray-200 border border-gray-200" onclick="setCurrentFillColor('#e5e7eb')" title="Fill: Light Gray"></button>
<button class="color-swatch w-4 h-4 rounded-full bg-red-100 border border-gray-200" onclick="setCurrentFillColor('#fee2e2')" title="Fill: Light Red"></button>
<button class="color-swatch w-4 h-4 rounded-full bg-blue-100 border border-gray-200" onclick="setCurrentFillColor('#dbeafe')" title="Fill: Light Blue"></button>
<button class="color-swatch w-4 h-4 rounded-full bg-green-100 border border-gray-200" onclick="setCurrentFillColor('#dcfce7')" title="Fill: Light Green"></button>
<div class="relative group w-4 h-4">
<input type=color class="opacity-0 absolute inset-0 w-full h-full cursor-pointer" oninput=setCurrentFillColor(this.value) title="Custom Fill Color" />
<div class="w-full h-full rounded-full bg-gradient-to-br from-purple-100 to-pink-100 border border-gray-200 flex items-center justify-center">
<i data-lucide=plus class="w-2 h-2 text-gray-500"></i>
</div>
</div>
</div>
</div>
<div class="toolbar-group hidden md:flex" style=gap:6px>
<i data-lucide=circle-dot class="w-4 h-4 text-gray-400 flex-shrink-0"></i>
<input type=range min=1 max=50 value=2 id=width-slider-desk class=w-20 oninput=setLineWidth(this.value) title="Thickness ([ / ])" />
<span id=width-val-desk class="text-xs text-gray-500 w-4 flex-shrink-0">2</span>
</div>
<div class=toolbar-group>
<button class="tool-btn p-2 rounded-lg text-gray-600 hover:bg-gray-100" onclick=downloadImage() title="Download (Ctrl+S)">
<i data-lucide=download class="w-4 h-4"></i>
</button>
<button class="tool-btn p-2 rounded-lg text-gray-600 hover:bg-gray-100" onclick="document.getElementById('imageInput').click()" title="Add Image">
<i data-lucide=image class="w-4 h-4"></i>
</button>
<input type=file id=imageInput accept=image/* class=hidden onchange=handleImageFile(this.files[0]) />
</div>
<div class=toolbar-group>
<button class="tool-btn p-2 rounded-lg text-gray-600 hover:bg-gray-100" onclick=undo() title="Undo (Ctrl+Z)">
<i data-lucide=undo-2 class="w-4 h-4"></i>
</button>
<button class="tool-btn p-2 rounded-lg text-gray-600 hover:bg-gray-100 text-red-500 hover:bg-red-50" onclick=clearBoard() title="Clear All (Alt+N)">
<i data-lucide=refresh-ccw class="w-4 h-4"></i>
</button>
</div>
<div id=selection-actions class="toolbar-group hidden">
<button class="tool-btn p-2 rounded-lg text-gray-600 hover:bg-gray-100" onclick=bringToFront() title="Bring to Front">
<i data-lucide=layers-2 class="w-4 h-4"></i>
</button>
<button class="tool-btn p-2 rounded-lg text-gray-600 hover:bg-gray-100" onclick=sendToBack() title="Send to Back">
<i data-lucide=layers class="w-4 h-4"></i>
</button>
<button id=btn-delete-selected class="tool-btn p-2 rounded-lg text-red-500 hover:bg-red-50" onclick=deleteSelected() title="Delete (Del)">
<i data-lucide=trash-2 class="w-4 h-4"></i>
</button>
</div>
</div>
<div id=alignment-bar class="absolute bottom-24 left-1/2 transform -translate-x-1/2 z-10 flex items-center gap-1 p-2 bg-white/90 backdrop-blur-sm rounded-xl shadow-lg border border-gray-200 hidden transition-all duration-200">
<button class="tool-btn p-2 rounded-xl text-gray-600 hover:bg-gray-100" onclick="alignSelected('left')" title="Align Left (L)">
<i data-lucide=arrow-left-to-line class="w-4 h-4"></i>
</button>
<button class="tool-btn p-2 rounded-xl text-gray-600 hover:bg-gray-100" onclick="alignSelected('center-h')" title="Align Center Horizontal (H / E)">
<i data-lucide=align-center-vertical class="w-4 h-4"></i>
</button>
<button class="tool-btn p-2 rounded-xl text-gray-600 hover:bg-gray-100" onclick="alignSelected('right')" title="Align Right (R)">
<i data-lucide=arrow-right-to-line class="w-4 h-4"></i>
</button>
<div class="w-px h-6 bg-gray-200 mx-1"></div>
<button class="tool-btn p-2 rounded-xl text-gray-600 hover:bg-gray-100" onclick="alignSelected('top')" title="Align Top (T)">
<i data-lucide=arrow-up-to-line class="w-4 h-4"></i>
</button>
<button class="tool-btn p-2 rounded-xl text-gray-600 hover:bg-gray-100" onclick="alignSelected('middle-v')" title="Align Middle Vertical (C / V)">
<i data-lucide=align-center-horizontal class="w-4 h-4"></i>
</button>
<button class="tool-btn p-2 rounded-xl text-gray-600 hover:bg-gray-100" onclick="alignSelected('bottom')" title="Align Bottom (B)">
<i data-lucide=arrow-down-to-line class="w-4 h-4"></i>
</button>
</div>
<div class="absolute bottom-6 right-4 md:right-6 z-20 md:hidden bg-white/90 backdrop-blur-sm p-3 rounded-2xl shadow-lg border border-gray-200 flex items-center gap-3 flex-shrink-0" style=max-width:85%;min-width:min(250px,85%)>
<i data-lucide=circle-dot-dashed class="w-4 h-4 text-gray-400 flex-shrink-0"></i>
<input type=range min=1 max=50 value=2 id=width-slider-mob class="flex-grow min-w-0" oninput=setLineWidth(this.value) />
<span id=width-val-mob class="text-xs text-gray-500 font-bold w-5 flex-shrink-0">2</span>
</div>
<div class="absolute top-3 md:top-4 right-4 md:right-6 z-20 flex items-center gap-2">
<button class="tool-btn p-2 md:p-3 bg-white/95 backdrop-blur-md rounded-2xl shadow-xl border border-gray-200 text-gray-600 hover:bg-gray-100 flex items-center gap-2" onclick=resetView() title="Reset View (Esc)">
<i data-lucide=refresh-cw class="w-4 md:w-5 h-4 md:h-5"></i>
<span class="text-xs font-bold hidden sm:inline" id=zoom-percentage>100%</span>
</button>
</div>
<canvas id=canvas></canvas>
<div id=toast class="absolute top-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none z-50 text-xs sm:text-sm">
Action Completed
</div>
<div id=shape-recognition-panel class="absolute top-4 left-1/2 transform -translate-x-1/2 bg-white rounded-lg shadow-xl border border-gray-200 px-4 py-3 z-50 hidden transition-all duration-300" style=opacity:0;transform:translate(-50%,-10px)>
<div class="flex items-center gap-2">
<button id=undo-shape-btn class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-md text-sm font-medium text-gray-700 transition-colors" onclick=undoShapeRecognition()>
Undo
</button>
<div class="w-px h-6 bg-gray-300"></div>
<button id=convert-rectangle-btn class="px-4 py-2 bg-blue-50 hover:bg-blue-100 rounded-md text-sm font-medium text-blue-700 transition-colors" onclick="convertToShape('rectangle')">
Rectangle
</button>
<button id=convert-circle-btn class="px-4 py-2 bg-blue-50 hover:bg-blue-100 rounded-md text-sm font-medium text-blue-700 transition-colors" onclick="convertToShape('circle')">
Circle
</button>
<button id=convert-triangle-btn class="px-4 py-2 bg-blue-50 hover:bg-blue-100 rounded-md text-sm font-medium text-blue-700 transition-colors" onclick="convertToShape('triangle')">
Triangle
</button>
</div>
</div>
<div id=context-menu class="absolute bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50 hidden overflow-y-auto" style=max-height:90vh>
<div class=context-menu-item id=paste-menu-item style=display:none onclick=pasteFromClipboard();hideContextMenu()>
<i data-lucide=clipboard-paste class="w-4 h-4 flex-shrink-0"></i>
<span>Paste</span>
</div>
<div class=context-menu-separator id=paste-separator style="display:none;height:1px;background-color:#e5e7eb;margin:4px 0"></div>
<div class=context-menu-item id=to-dotted-line-item style=display:none onclick=toggleDottedLine();hideContextMenu()>
<i data-lucide=circle-dot-dashed class="w-4 h-4 flex-shrink-0"></i>
<span>Toggle Dotted Line</span>
</div>
<div id=arrow-toggles-container style="display:none;padding:2px 4px">
<div style=display:flex;gap:4px>
<div class=context-menu-item id=toggle-start-arrow-item style="flex:1;justify-content:center;padding:8px 4px" onclick=toggleStartArrow();hideContextMenu() title="Toggle Start Arrow">
<i data-lucide=arrow-left class="w-4 h-4 flex-shrink-0"></i>
<span>Start</span>
</div>
<div class=context-menu-item id=toggle-end-arrow-item style="flex:1;justify-content:center;padding:8px 4px" onclick=toggleEndArrow();hideContextMenu() title="Toggle End Arrow">
<span>End</span>
<i data-lucide=arrow-right class="w-4 h-4 flex-shrink-0"></i>
</div>
</div>
</div>
<div class=context-menu-separator id=editing-layering-separator style="display:none;height:1px;background-color:#e5e7eb;margin:4px 0"></div>
<div id=layering-actions-container style="display:none;padding:2px 4px">
<div style=display:flex;gap:4px>
<div class=context-menu-item id=send-to-back-item style="flex:1;justify-content:center;padding:8px 4px" onclick=sendToBack();hideContextMenu() title="Send to Back">
<i data-lucide=layers class="w-4 h-4 flex-shrink-0"></i>
<span>Back</span>
</div>
<div class=context-menu-item id=bring-to-front-item style="flex:1;justify-content:center;padding:8px 4px" onclick=bringToFront();hideContextMenu() title="Bring to Front">
<span>Front</span>
<i data-lucide=layers-2 class="w-4 h-4 flex-shrink-0"></i>
</div>
</div>
</div>
<div class=context-menu-separator id=layering-delete-separator style="display:none;height:1px;background-color:#e5e7eb;margin:4px 0"></div>
<div class=context-menu-item id=duplicate-item style=display:none onclick=duplicateSelected();hideContextMenu()>
<i data-lucide=copy class="w-4 h-4 flex-shrink-0"></i>
<span>Duplicate</span>
</div>
<div class="context-menu-item text-red-500" id=delete-item style=display:none onclick=deleteSelected();hideContextMenu()>
<i data-lucide=trash-2 class="w-4 h-4 flex-shrink-0"></i>
<span>Delete</span>
</div>
<div class=context-menu-separator id=shape-conversion-separator style="display:none;height:1px;background-color:#e5e7eb;margin:4px 0"></div>
<div class=context-menu-item id=change-to-rectangle-item style=display:none onclick="changeSelectedShapesType('rect');hideContextMenu()">
<i data-lucide=square class="w-4 h-4 flex-shrink-0"></i>
<span>To Rectangle</span>
</div>
<div class=context-menu-item id=change-to-circle-item style=display:none onclick="changeSelectedShapesType('circle');hideContextMenu()">
<i data-lucide=circle class="w-4 h-4 flex-shrink-0"></i>
<span>To Circle</span>
</div>
<div class=context-menu-item id=change-to-triangle-item style=display:none onclick="changeSelectedShapesType('triangle');hideContextMenu()">
<i data-lucide=triangle class="w-4 h-4 flex-shrink-0"></i>
<span>To Triangle</span>
</div>
<div class=context-menu-item id=change-to-oval-item style=display:none onclick="changeSelectedShapesType('oval');hideContextMenu()">
<i data-lucide=circle class="w-4 h-4 flex-shrink-0"></i>
<span>To Oval</span>
</div>
<div class=context-menu-item id=change-to-rhombus-item style=display:none onclick="changeSelectedShapesType('rhombus');hideContextMenu()">
<i data-lucide=square-round-corner class="w-4 h-4 flex-shrink-0"></i>
<span>To Rhombus</span>
</div>
<div class=context-menu-item id=change-to-diamond-item style=display:none onclick="changeSelectedShapesType('diamond');hideContextMenu()">
<i data-lucide=diamond class="w-4 h-4 flex-shrink-0"></i>
<span>To Diamond</span>
</div>
</div>
<div id=floating-toolbar class="absolute z-30 p-2 bg-white/95 backdrop-blur-md rounded-xl shadow-xl border border-gray-200 hidden flex-col gap-2 transition-all duration-200" style=left:0;top:0;transform:translate(-50%,-100%);margin-top:-15px>
<div class="flex items-center gap-1 border-b border-gray-100 pb-2 mb-0 justify-center">
<button class="tool-btn p-1.5 rounded-lg text-gray-600 hover:bg-gray-100 h-8 w-8" onclick=toggleDottedLine() title="Toggle Dotted Line">
<i data-lucide=circle-dot-dashed class="w-4 h-4"></i>
</button>
<div class="w-px h-5 bg-gray-200 mx-1"></div>
<button class="tool-btn p-1.5 rounded-lg text-gray-600 hover:bg-gray-100 h-8 w-8" onclick=bringToFront() title="Bring to Front">
<i data-lucide=layers-2 class="w-4 h-4"></i>
</button>
<button class="tool-btn p-1.5 rounded-lg text-gray-600 hover:bg-gray-100 h-8 w-8" onclick=sendToBack() title="Send to Back">
<i data-lucide=layers class="w-4 h-4"></i>
</button>
</div>
<div class="flex flex-col gap-1.5">
<div class="flex items-center gap-1 justify-center">
<button class="color-swatch w-5 h-5 rounded-full bg-black border border-gray-200" onclick="setCurrentStrokeColor('#000000')" title="Stroke: Black"></button>
<button class="color-swatch w-5 h-5 rounded-full bg-red-500 border border-gray-200" onclick="setCurrentStrokeColor('#ef4444')" title="Stroke: Red"></button>
<button class="color-swatch w-5 h-5 rounded-full bg-blue-500 border border-gray-200" onclick="setCurrentStrokeColor('#3b82f6')" title="Stroke: Blue"></button>
<button class="color-swatch w-5 h-5 rounded-full bg-green-500 border border-gray-200" onclick="setCurrentStrokeColor('#22c55e')" title="Stroke: Green"></button>
<div class="relative group w-5 h-5">
<input type=color class="opacity-0 absolute inset-0 w-full h-full cursor-pointer" oninput=setCurrentStrokeColor(this.value) title="Custom Stroke" />
<div class="w-full h-full rounded-full bg-gradient-to-br from-gray-700 to-black border border-gray-200 flex items-center justify-center">
<i data-lucide=plus class="w-3 h-3 text-white"></i>
</div>
</div>
</div>
<div class="flex items-center gap-1 justify-center">
<button class="color-swatch w-5 h-5 rounded-full transparent-swatch border border-gray-300" onclick="setCurrentFillColor('transparent')" title="Fill: Transparent"></button>
<button class="color-swatch w-5 h-5 rounded-full bg-gray-200 border border-gray-200" onclick="setCurrentFillColor('#e5e7eb')" title="Fill: Gray"></button>
<button class="color-swatch w-5 h-5 rounded-full bg-blue-100 border border-gray-200" onclick="setCurrentFillColor('#dbeafe')" title="Fill: Blue"></button>
<button class="color-swatch w-5 h-5 rounded-full bg-green-100 border border-gray-200" onclick="setCurrentFillColor('#dcfce7')" title="Fill: Green"></button>
<div class="relative group w-5 h-5">
<input type=color class="opacity-0 absolute inset-0 w-full h-full cursor-pointer" oninput=setCurrentFillColor(this.value) title="Custom Fill" />
<div class="w-full h-full rounded-full bg-gradient-to-br from-purple-100 to-pink-100 border border-gray-200 flex items-center justify-center">
<i data-lucide=plus class="w-3 h-3 text-gray-500"></i>
</div>
</div>
</div>
</div>
</div>
<div id=plus-icon-tooltip>Add connected shape <kbd>+</kbd></div>
<script>window.addEventListener("load",function(){if(typeof lucide!=="undefined"){lucide.createIcons();}});const canvas=document.getElementById("canvas");const ctx=canvas.getContext("2d");const toastEl=document.getElementById("toast");const btnDeleteSelected=document.getElementById("btn-delete-selected");const alignmentBar=document.getElementById("alignment-bar");const floatingToolbar=document.getElementById("floating-toolbar");const plusIconTooltip=document.getElementById("plus-icon-tooltip");let shapes=[];let historyStack=[];let historyStep=-1;const MAX_HISTORY=40;let currentTool="pencil";let currentColor="#000000";let currentFillColor="transparent";let currentWidth=2;let isDragging=false;let startPos={x:0,y:0};let currentShape=null;let selectedIndices=new Set();let selectionQueue=[];let selectionBox=null;function clearSelection(){selectedIndices.clear();selectionQueue=[];hoveredSide=null;hoveredRectIndex=null;}
function addToSelection(idx){if(!selectedIndices.has(idx)){selectedIndices.add(idx);if(!selectionQueue.includes(idx)){selectionQueue.push(idx);}}}
function removeFromSelection(idx){selectedIndices.delete(idx);selectionQueue=selectionQueue.filter((i)=>i!==idx);}
let arrowCreationPhase="idle";let laserShapes=[];const LASER_LIFETIME=2000;const LASER_DELETE_DELAY=500;const LASER_DELETE_DURATION=1000;const LASER_MAX_TAIL=100;let originalPencilShape=null;let convertedShapeIndex=-1;let shapeRecognitionPanelTimer=null;let isManipulatingHandle=false;let isMovingSelection=false;let isBoxSelecting=false;let isDuplicating=false;let activeHandle=null;let moveOffset={x:0,y:0};let initialShapeState=null;let temporarilyDisconnectedShapes=new Map();let hoveredSide=null;let hoveredRectIndex=null;let connectionHoverShape=null;let contextMenuTarget=null;let isTyping=false;let isFinishingText=false;let activeInput=null;let camera={x:0,y:0,scale:1,isPanning:false,};function toWorld(screenX,screenY){return{x:(screenX-camera.x)/camera.scale,y:(screenY-camera.y)/camera.scale,};}
function toScreen(worldX,worldY){return{x:worldX*camera.scale+camera.x,y:worldY*camera.scale+camera.y,};}
function generateId(){return"shape_"+Date.now()+"_"+Math.random().toString(36).substr(2,9);}
function resizeCanvas(){canvas.width=window.innerWidth;canvas.height=window.innerHeight;render();}
window.addEventListener("resize",resizeCanvas);canvas.addEventListener("wheel",(e)=>{if(e.ctrlKey){e.preventDefault();const zoomSpeed=0.001;const delta=-e.deltaY;const factor=Math.pow(1.1,delta/100);const rect=canvas.getBoundingClientRect();const mouseX=e.clientX-rect.left;const mouseY=e.clientY-rect.top;const worldPos=toWorld(mouseX,mouseY);camera.scale*=factor;camera.scale=Math.min(Math.max(0.1,camera.scale),20);const newScreenPos=toScreen(worldPos.x,worldPos.y);camera.x-=newScreenPos.x-mouseX;camera.y-=newScreenPos.y-mouseY;render();}},{passive:false});function render(){ctx.setTransform(1,0,0,1,0,0);ctx.clearRect(0,0,canvas.width,canvas.height);ctx.fillStyle="#ffffff";ctx.fillRect(0,0,canvas.width,canvas.height);drawGrid();ctx.setTransform(camera.scale,0,0,camera.scale,camera.x,camera.y);shapes.forEach((shape,index)=>{const isSelected=selectedIndices.has(index);const isConnectionHover=connectionHoverShape&&connectionHoverShape.id===shape.id;drawShape(shape,isSelected);if(isConnectionHover&&!isSelected){const b=getBoundingBox(shape);ctx.save();ctx.strokeStyle="#3b82f6";ctx.lineWidth=3/camera.scale;ctx.setLineDash([]);ctx.globalAlpha=0.6;if(shape.type==="circle"){const centerX=b.x+b.w/2;const centerY=b.y+b.h/2;const radiusX=Math.abs(b.w)/2;const radiusY=Math.abs(b.h)/2;ctx.beginPath();ctx.ellipse(centerX,centerY,radiusX+4/camera.scale,radiusY+4/camera.scale,0,0,Math.PI*2);ctx.stroke();}else if(shape.type==="rhombus"||shape.type==="diamond"){const centerX=b.x+b.w/2;const centerY=b.y+b.h/2;const hw=Math.abs(b.w)/2+4/camera.scale;const hh=Math.abs(b.h)/2+4/camera.scale;ctx.beginPath();ctx.moveTo(centerX,centerY-hh);ctx.lineTo(centerX+hw,centerY);ctx.lineTo(centerX,centerY+hh);ctx.lineTo(centerX-hw,centerY);ctx.closePath();ctx.stroke();}else{const padding=4/camera.scale;ctx.strokeRect(b.x-padding,b.y-padding,b.w+padding*2,b.h+padding*2);}
ctx.restore();}});if(currentTool==="select"&&selectedIndices.size>1){const groupBounds=getSelectionBounds();if(groupBounds){drawSelectionHandles({...groupBounds,type:"group_handle_drawing",});}}
laserShapes.forEach((laserShape)=>{drawShape(laserShape,false);});if(currentShape){drawShape(currentShape,false);}
if(selectionBox){ctx.save();ctx.strokeStyle="#3b82f6";ctx.fillStyle="rgba(59, 130, 246, 0.1)";ctx.lineWidth=1/camera.scale;ctx.setLineDash([4/camera.scale,4/camera.scale]);const x=Math.min(selectionBox.start.x,selectionBox.end.x);const y=Math.min(selectionBox.start.y,selectionBox.end.y);const w=Math.abs(selectionBox.end.x-selectionBox.start.x);const h=Math.abs(selectionBox.end.y-selectionBox.start.y);ctx.fillRect(x,y,w,h);ctx.strokeRect(x,y,w,h);ctx.restore();}
if(currentTool==="select"&&selectedIndices.size===1){const idx=selectedIndices.values().next().value;const shape=shapes[idx];if(shape&&(shape.type==="rect"||shape.type==="circle"||shape.type==="oval"||shape.type==="rhombus"||shape.type==="diamond")&&hoveredSide){const iconPos=getPlusIconPosition(shape,hoveredSide);if(iconPos){drawPlusIcon(ctx,iconPos.x,iconPos.y,hoveredSide);const shortcuts={top:"Ctrl+â†‘",bottom:"Ctrl+â†“",left:"Ctrl+â†",right:"Ctrl+â†’",};plusIconTooltip.textContent=shortcuts[hoveredSide]||"";const screenPos=toScreen(iconPos.x,iconPos.y);const tooltipOffset=20;if(hoveredSide==="top"){plusIconTooltip.style.left=screenPos.x+"px";plusIconTooltip.style.top=screenPos.y-tooltipOffset+"px";plusIconTooltip.style.transform="translate(-50%, -100%)";}else if(hoveredSide==="bottom"){plusIconTooltip.style.left=screenPos.x+"px";plusIconTooltip.style.top=screenPos.y+tooltipOffset+"px";plusIconTooltip.style.transform="translateX(-50%)";}else if(hoveredSide==="left"){plusIconTooltip.style.left=screenPos.x-tooltipOffset+"px";plusIconTooltip.style.top=screenPos.y+"px";plusIconTooltip.style.transform="translate(-100%, -50%)";}else if(hoveredSide==="right"){plusIconTooltip.style.left=screenPos.x+tooltipOffset+"px";plusIconTooltip.style.top=screenPos.y+"px";plusIconTooltip.style.transform="translateY(-50%)";}
plusIconTooltip.classList.add("visible");}else{plusIconTooltip.classList.remove("visible");}}else{plusIconTooltip.classList.remove("visible");}}else{plusIconTooltip.classList.remove("visible");}
const zoomEl=document.getElementById("zoom-percentage");if(zoomEl){zoomEl.textContent=Math.round(camera.scale*100)+"%";}
if(selectedIndices.size>0){document.getElementById("selection-actions").classList.remove("hidden");}else{document.getElementById("selection-actions").classList.add("hidden");}
if(selectedIndices.size>1){alignmentBar.classList.remove("hidden");alignmentBar.classList.add("flex");}else{alignmentBar.classList.add("hidden");alignmentBar.classList.remove("flex");}
updateFloatingToolbar();}
function drawGrid(){const gridSize=50*camera.scale;const offsetX=camera.x%gridSize;const offsetY=camera.y%gridSize;ctx.save();ctx.setTransform(1,0,0,1,0,0);ctx.beginPath();ctx.strokeStyle="#fafbfc";ctx.lineWidth=0.5;ctx.globalAlpha=0.4;for(let x=offsetX;x<=canvas.width;x+=gridSize){ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);}
for(let y=offsetY;y<=canvas.height;y+=gridSize){ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);}
ctx.stroke();ctx.restore();}
function catmullRom(p0,p1,p2,p3,t){const t2=t*t;const t3=t2*t;return(0.5*(2*p1+
(-p0+p2)*t+
(2*p0-5*p1+4*p2-p3)*t2+
(-p0+3*p1-3*p2+p3)*t3));}
function drawShape(shape,isSelected){ctx.save();ctx.lineCap="round";ctx.lineJoin="round";ctx.strokeStyle=shape.color;ctx.lineWidth=shape.width;ctx.fillStyle=shape.fillColor||"transparent";if(shape.isDotted){ctx.setLineDash([4/camera.scale,12/camera.scale]);}
const isFilled=shape.fillColor&&shape.fillColor!=="transparent";const isStroked=shape.color&&shape.color!=="transparent";if(shape.type==="laser"){if(shape.points.length>1){const deletedCount=shape.deletedCount||0;const visiblePoints=shape.points.slice(deletedCount);const tailOpacity=shape.tailOpacity!==undefined?shape.tailOpacity:1;if(visiblePoints.length>1){const r=parseInt(shape.color.slice(1,3),16);const g=parseInt(shape.color.slice(3,5),16);const b=parseInt(shape.color.slice(5,7),16);for(let i=0;i<visiblePoints.length-1;i++){const p0=visiblePoints[Math.max(0,i-1)];const p1=visiblePoints[i];const p2=visiblePoints[i+1];const p3=visiblePoints[Math.min(visiblePoints.length-1,i+2)];const progress=i/Math.max(1,visiblePoints.length-1);const alpha=Math.max(0,Math.min(0.8,0.8*Math.sin(progress*Math.PI))*tailOpacity);ctx.strokeStyle=`rgba(${r},${g},${b},${alpha})`;ctx.lineWidth=shape.width*(0.7+0.6*progress);ctx.beginPath();ctx.moveTo(p1.x,p1.y);for(let t=0.1;t<=1;t+=0.1){const x=catmullRom(p0.x,p1.x,p2.x,p3.x,t);const y=catmullRom(p0.y,p1.y,p2.y,p3.y,t);ctx.lineTo(x,y);}
ctx.stroke();}}}}else if(shape.type==="pencil"||shape.type==="pencil-arrow"){if(shape.points.length>0){ctx.beginPath();ctx.moveTo(shape.points[0].x,shape.points[0].y);if(shape.points.length>1){for(let i=1;i<shape.points.length;i++){const curr=shape.points[i];if(i===1){ctx.lineTo(curr.x,curr.y);}else{const next=shape.points[Math.min(i+1,shape.points.length-1)];const nextMidX=(curr.x+next.x)/2;const nextMidY=(curr.y+next.y)/2;ctx.quadraticCurveTo(curr.x,curr.y,nextMidX,nextMidY);}}
ctx.lineTo(shape.points[shape.points.length-1].x,shape.points[shape.points.length-1].y);}
if(isStroked)ctx.stroke();if(shape.hasStartArrow&&shape.points.length>1){const points=shape.points;const first=points[0];let angleSum=0;let validAngles=0;const lookAheadCount=Math.min(5,points.length-1);for(let j=1;j<=lookAheadCount;j++){const next=points[j];if(next.x!==first.x||next.y!==first.y){const angle=Math.atan2(next.y-first.y,next.x-first.x);angleSum+=angle;validAngles++;}}
if(validAngles>0){const avgAngle=angleSum/validAngles;ctx.fillStyle=shape.color&&shape.color!=="transparent"?shape.color:"#000000";drawArrowHead(ctx,first.x,first.y,avgAngle+Math.PI,shape.width*5);}}
const showEndArrow=shape.hasEndArrow!==undefined?shape.hasEndArrow:(shape.type==="pencil-arrow");if(showEndArrow&&shape.points.length>1){const points=shape.points;const last=points[points.length-1];let angleSum=0;let validAngles=0;const lookBackCount=Math.min(5,points.length-1);for(let j=1;j<=lookBackCount;j++){const idx=Math.max(0,points.length-1-j);const prev=points[idx];if(prev.x!==last.x||prev.y!==last.y){const angle=Math.atan2(last.y-prev.y,last.x-prev.x);angleSum+=angle;validAngles++;}}
if(validAngles>0){const avgAngle=angleSum/validAngles;ctx.fillStyle=shape.color&&shape.color!=="transparent"?shape.color:"#000000";drawArrowHead(ctx,last.x,last.y,avgAngle,shape.width*5);}}}}else if(shape.type==="line"){ctx.beginPath();ctx.moveTo(shape.start.x,shape.start.y);ctx.lineTo(shape.end.x,shape.end.y);if(isStroked)ctx.stroke();ctx.fillStyle=shape.color&&shape.color!=="transparent"?shape.color:"#000000";if(shape.hasStartArrow){const dx=shape.end.x-shape.start.x;const dy=shape.end.y-shape.start.y;const angle=Math.atan2(dy,dx)+Math.PI;drawArrowHead(ctx,shape.start.x,shape.start.y,angle,shape.width*5);}
if(shape.hasEndArrow){const dx=shape.end.x-shape.start.x;const dy=shape.end.y-shape.start.y;const angle=Math.atan2(dy,dx);drawArrowHead(ctx,shape.end.x,shape.end.y,angle,shape.width*5);}}else if(shape.type==="arrow"){ctx.beginPath();ctx.moveTo(shape.start.x,shape.start.y);const cp=shape.control||{x:(shape.start.x+shape.end.x)/2,y:(shape.start.y+shape.end.y)/2,};ctx.quadraticCurveTo(cp.x,cp.y,shape.end.x,shape.end.y);if(isStroked)ctx.stroke();ctx.fillStyle=shape.color&&shape.color!=="transparent"?shape.color:"#000000";if(shape.hasStartArrow){const dxS=cp.x-shape.start.x;const dyS=cp.y-shape.start.y;let angleS=Math.atan2(dyS,dxS)+Math.PI;if(dxS===0&&dyS===0){angleS=Math.atan2(shape.end.y-shape.start.y,shape.end.x-shape.start.x)+Math.PI;}
drawArrowHead(ctx,shape.start.x,shape.start.y,angleS,shape.width*5);}
const showEndArrow=shape.hasEndArrow!==undefined?shape.hasEndArrow:true;if(showEndArrow){const dx=shape.end.x-cp.x;const dy=shape.end.y-cp.y;let angle=Math.atan2(dy,dx);if(dx===0&&dy===0){angle=Math.atan2(shape.end.y-shape.start.y,shape.end.x-shape.start.x);}
drawArrowHead(ctx,shape.end.x,shape.end.y,angle,shape.width*5);}}else if(shape.type==="rect"){if(isFilled)ctx.fillRect(shape.x,shape.y,shape.w,shape.h);if(isStroked)ctx.strokeRect(shape.x,shape.y,shape.w,shape.h);}else if(shape.type==="circle"){ctx.beginPath();const rx=Math.abs(shape.w/2);const ry=Math.abs(shape.h/2);const cx=shape.x+shape.w/2;const cy=shape.y+shape.h/2;ctx.ellipse(cx,cy,rx,ry,0,0,2*Math.PI);if(isFilled)ctx.fill();if(isStroked)ctx.stroke();}else if(shape.type==="triangle"){ctx.beginPath();ctx.moveTo(shape.x+shape.w/2,shape.y);ctx.lineTo(shape.x+shape.w,shape.y+shape.h);ctx.lineTo(shape.x,shape.y+shape.h);ctx.closePath();if(isFilled)ctx.fill();if(isStroked)ctx.stroke();}else if(shape.type==="oval"){ctx.beginPath();const radius=Math.min(Math.abs(shape.w),Math.abs(shape.h))/2;ctx.roundRect(shape.x,shape.y,shape.w,shape.h,radius);if(isFilled)ctx.fill();if(isStroked)ctx.stroke();}else if(shape.type==="rhombus"){ctx.beginPath();const skew=shape.w*0.1;const x=shape.x;const y=shape.y;const w=shape.w;const h=shape.h;ctx.moveTo(x+skew,y);ctx.lineTo(x+w,y);ctx.lineTo(x+w-skew,y+h);ctx.lineTo(x,y+h);ctx.closePath();if(isFilled)ctx.fill();if(isStroked)ctx.stroke();}else if(shape.type==="diamond"){ctx.beginPath();const cx=shape.x+shape.w/2;const cy=shape.y+shape.h/2;ctx.moveTo(cx,shape.y);ctx.lineTo(shape.x+shape.w,cy);ctx.lineTo(cx,shape.y+shape.h);ctx.lineTo(shape.x,cy);ctx.closePath();if(isFilled)ctx.fill();if(isStroked)ctx.stroke();}else if(shape.type==="text"){ctx.font=`bold ${shape.size}px'Caveat',cursive`;ctx.textBaseline="top";ctx.fillStyle=shape.color;if(isStroked)ctx.fillText(shape.text,shape.x,shape.y);}else if(shape.type==="image"){if(shape.image&&shape.image.complete){ctx.drawImage(shape.image,shape.x,shape.y,shape.w,shape.h);}else{ctx.fillStyle="#e5e7eb";ctx.fillRect(shape.x,shape.y,shape.w,shape.h);ctx.strokeStyle="#9ca3af";ctx.strokeRect(shape.x,shape.y,shape.w,shape.h);}}
if((shape.type==="rect"||shape.type==="circle"||shape.type==="triangle"||shape.type==="oval"||shape.type==="rhombus"||shape.type==="diamond")&&shape.innerText&&!shape.isEditingText){ctx.save();ctx.font=`bold ${shape.innerTextSize||20}px'Caveat',cursive`;ctx.textBaseline="middle";ctx.textAlign="center";ctx.fillStyle=shape.innerTextColor||"#000000";const centerX=shape.x+shape.w/2;const centerY=shape.y+shape.h/2;ctx.fillText(shape.innerText,centerX,centerY);ctx.restore();}
ctx.restore();if(isSelected){if(selectedIndices.size===1){drawSelectionHandles(shape);}else{drawSimpleBoundingBox(shape);}}}
function drawArrowHead(ctx,x,y,angle,size){ctx.save();ctx.translate(x,y);ctx.rotate(angle);ctx.beginPath();ctx.moveTo(-size,-size/2);ctx.lineTo(0,0);ctx.lineTo(-size,size/2);ctx.stroke();ctx.restore();}
function drawSimpleBoundingBox(shape){ctx.save();ctx.strokeStyle="#3b82f6";ctx.lineWidth=2/camera.scale;ctx.setLineDash([4/camera.scale,4/camera.scale]);const b=getBoundingBox(shape);const padding=5/camera.scale;if(shape.type==="pencil"||shape.type==="pencil-arrow"||shape.type==="line"||shape.type==="arrow"){ctx.strokeRect(b.x-padding,b.y-padding,b.w+padding*2,b.h+padding*2);}else if(shape.type==="text"){ctx.font=`bold ${shape.size}px'Caveat',cursive`;ctx.textBaseline="top";const m=ctx.measureText(shape.text);ctx.strokeRect(shape.x-padding,shape.y-padding,m.width+padding*2,shape.size+padding*2);}else{const x=Math.min(shape.x,shape.x+shape.w);const y=Math.min(shape.y,shape.y+shape.h);const w=Math.abs(shape.w);const h=Math.abs(shape.h);ctx.strokeRect(x-padding,y-padding,w+padding*2,h+padding*2);}
ctx.restore();}
function drawSelectionHandles(shape){ctx.save();ctx.fillStyle="#ffffff";ctx.strokeStyle="#3b82f6";ctx.lineWidth=2/camera.scale;if(shape.type==="arrow"||shape.type==="line"){const cp=shape.control||{x:(shape.start.x+shape.end.x)/2,y:(shape.start.y+shape.end.y)/2,};drawHandle(shape.start.x,shape.start.y);drawHandle(shape.end.x,shape.end.y);if(shape.type==="arrow"){ctx.fillStyle="#fcd34d";drawHandle(cp.x,cp.y);ctx.setLineDash([4/camera.scale,4/camera.scale]);ctx.beginPath();ctx.moveTo(shape.start.x,shape.start.y);ctx.lineTo(cp.x,cp.y);ctx.lineTo(shape.end.x,shape.end.y);ctx.stroke();}else if(shape.type==="line"){ctx.fillStyle="#fcd34d";drawHandle(cp.x,cp.y);}}else{let x,y,w,h;if(shape.type==="text"||shape.type==="pencil"||shape.type==="pencil-arrow"||shape.type==="image"){const b=getBoundingBox(shape);x=b.x;y=b.y;w=b.w;h=b.h;}else{x=shape.x;y=shape.y;w=shape.w;h=shape.h;}
const padding=5/camera.scale;ctx.setLineDash([4/camera.scale,4/camera.scale]);ctx.strokeRect(x-padding,y-padding,w+padding*2,h+padding*2);drawHandle(x,y);drawHandle(x+w,y);drawHandle(x,y+h);drawHandle(x+w,y+h);}
ctx.restore();}
function drawHandle(x,y){const handleSize=6/camera.scale;ctx.beginPath();ctx.arc(x,y,handleSize,0,2*Math.PI);ctx.fill();ctx.stroke();}
function drawSquareHandle(x,y,size){ctx.fillRect(x-size,y-size,size*2,size*2);ctx.strokeRect(x-size,y-size,size*2,size*2);}
function detectHoveredSide(pos,shape){if(shape.type==="rect"||shape.type==="rhombus"||shape.type==="diamond"||shape.type==="oval"){return detectHoveredSideForRect(pos,shape);}else if(shape.type==="circle"){return detectHoveredSideForCircle(pos,shape);}
return null;}
function detectHoveredSideForRect(pos,rectShape){if(rectShape.type!=="rect"&&rectShape.type!=="rhombus"&&rectShape.type!=="diamond"&&rectShape.type!=="oval")
return null;const x=Math.min(rectShape.x,rectShape.x+rectShape.w);const y=Math.min(rectShape.y,rectShape.y+rectShape.h);const w=Math.abs(rectShape.w);const h=Math.abs(rectShape.h);const hoverThreshold=30/camera.scale;const edgeThreshold=10/camera.scale;const isNearRect=pos.x>=x-hoverThreshold&&pos.x<=x+w+hoverThreshold&&pos.y>=y-hoverThreshold&&pos.y<=y+h+hoverThreshold;if(!isNearRect)return null;const distToTop=Math.abs(pos.y-y);const distToBottom=Math.abs(pos.y-(y+h));const distToLeft=Math.abs(pos.x-x);const distToRight=Math.abs(pos.x-(x+w));const isInside=pos.x>x+edgeThreshold&&pos.x<x+w-edgeThreshold&&pos.y>y+edgeThreshold&&pos.y<y+h-edgeThreshold;if(isInside)return null;const minDist=Math.min(distToTop,distToBottom,distToLeft,distToRight);if(minDist>hoverThreshold)return null;const sideMiddleThreshold=Math.min(w,h)*0.3;if(distToTop===minDist){const centerX=x+w/2;if(Math.abs(pos.x-centerX)<sideMiddleThreshold){return"top";}}else if(distToBottom===minDist){const centerX=x+w/2;if(Math.abs(pos.x-centerX)<sideMiddleThreshold){return"bottom";}}else if(distToLeft===minDist){const centerY=y+h/2;if(Math.abs(pos.y-centerY)<sideMiddleThreshold){return"left";}}else if(distToRight===minDist){const centerY=y+h/2;if(Math.abs(pos.y-centerY)<sideMiddleThreshold){return"right";}}
return null;}
function drawPlusIcon(ctx,x,y,side){const iconSize=20/camera.scale;const lineWidth=2/camera.scale;const radius=iconSize/2;ctx.save();ctx.fillStyle="#ffffff";ctx.strokeStyle="#3b82f6";ctx.lineWidth=lineWidth;ctx.beginPath();ctx.arc(x,y,radius,0,2*Math.PI);ctx.fill();ctx.stroke();ctx.strokeStyle="#3b82f6";ctx.lineWidth=lineWidth*1.5;ctx.lineCap="round";const plusSize=radius*0.6;ctx.beginPath();ctx.moveTo(x-plusSize,y);ctx.lineTo(x+plusSize,y);ctx.stroke();ctx.beginPath();ctx.moveTo(x,y-plusSize);ctx.lineTo(x,y+plusSize);ctx.stroke();ctx.restore();}
function detectHoveredSideForCircle(pos,circleShape){if(circleShape.type!=="circle")return null;const cx=circleShape.x+circleShape.w/2;const cy=circleShape.y+circleShape.h/2;const rx=Math.abs(circleShape.w/2);const ry=Math.abs(circleShape.h/2);const dx=pos.x-cx;const dy=pos.y-cy;const distFromCenter=Math.hypot(dx/rx,dy/ry);const hoverThreshold=30/camera.scale;const edgeThreshold=0.1;const isNearEdge=Math.abs(distFromCenter-1)*Math.max(rx,ry)<hoverThreshold;const isInside=distFromCenter<1-edgeThreshold;if(!isNearEdge||isInside)return null;const angle=Math.atan2(dy,dx);let angleDeg=(angle*180)/Math.PI;if(angleDeg<0)angleDeg+=360;const cornerThreshold=30;if(angleDeg>=270-cornerThreshold&&angleDeg<=270+cornerThreshold){return"top";}
else if(angleDeg>=360-cornerThreshold||angleDeg<=cornerThreshold){return"right";}
else if(angleDeg>=90-cornerThreshold&&angleDeg<=90+cornerThreshold){return"bottom";}
else if(angleDeg>=180-cornerThreshold&&angleDeg<=180+cornerThreshold){return"left";}
return null;}
function getPlusIconPosition(shape,side){const offset=30/camera.scale;if(shape.type==="rect"||shape.type==="diamond"||shape.type==="oval"){const x=Math.min(shape.x,shape.x+shape.w);const y=Math.min(shape.y,shape.y+shape.h);const w=Math.abs(shape.w);const h=Math.abs(shape.h);switch(side){case"top":return{x:x+w/2,y:y-offset};case"right":return{x:x+w+offset,y:y+h/2};case"bottom":return{x:x+w/2,y:y+h+offset};case"left":return{x:x-offset,y:y+h/2};default:return null;}}else if(shape.type==="rhombus"){const x=shape.x;const y=shape.y;const w=shape.w;const h=shape.h;const skew=w*0.1;switch(side){case"top":return{x:x+w/2+skew/2,y:y-offset};case"bottom":return{x:x+w/2-skew/2,y:y+h+offset};case"left":return{x:x+skew/2-offset,y:y+h/2};case"right":return{x:x+w-skew/2+offset,y:y+h/2};default:return null;}}else if(shape.type==="circle"){const cx=shape.x+shape.w/2;const cy=shape.y+shape.h/2;const rx=Math.abs(shape.w/2);const ry=Math.abs(shape.h/2);const radius=Math.max(rx,ry);switch(side){case"top":return{x:cx,y:cy-radius-offset};case"right":return{x:cx+radius+offset,y:cy};case"bottom":return{x:cx,y:cy+radius+offset};case"left":return{x:cx-radius-offset,y:cy};default:return null;}}
return null;}
function isPointOnPlusIcon(pos,iconPos){if(!iconPos)return false;const iconSize=20/camera.scale;const radius=iconSize/2;return Math.hypot(pos.x-iconPos.x,pos.y-iconPos.y)<radius*1.5;}
function createLinkedShapeOnSide(side){if(!side)return false;if(selectedIndices.size!==1)return false;const idx=selectedIndices.values().next().value;const shape=shapes[idx];if(!shape||(shape.type!=="rect"&&shape.type!=="circle"&&shape.type!=="oval"&&shape.type!=="rhombus"&&shape.type!=="diamond"))
return false;const offset=60/camera.scale;let newShapeX,newShapeY,newShapeW,newShapeH;let arrowStartX,arrowStartY,arrowEndX,arrowEndY;if(shape.type==="rect"||shape.type==="rhombus"||shape.type==="diamond"||shape.type==="oval"){const x=Math.min(shape.x,shape.x+shape.w);const y=Math.min(shape.y,shape.y+shape.h);const w=Math.abs(shape.w);const h=Math.abs(shape.h);const newRectWidth=w;const newRectHeight=h;switch(side){case"top":newShapeX=x+w/2-newRectWidth/2;newShapeY=y-offset-newRectHeight;arrowStartX=x+w/2;arrowStartY=y;arrowEndX=newShapeX+newRectWidth/2;arrowEndY=newShapeY+newRectHeight;break;case"right":newShapeX=x+w+offset;newShapeY=y+h/2-newRectHeight/2;arrowStartX=x+w;arrowStartY=y+h/2;arrowEndX=newShapeX;arrowEndY=newShapeY+newRectHeight/2;break;case"bottom":newShapeX=x+w/2-newRectWidth/2;newShapeY=y+h+offset;arrowStartX=x+w/2;arrowStartY=y+h;arrowEndX=newShapeX+newRectWidth/2;arrowEndY=newShapeY;break;case"left":newShapeX=x-offset-newRectWidth;newShapeY=y+h/2-newRectHeight/2;arrowStartX=x;arrowStartY=y+h/2;arrowEndX=newShapeX+newRectWidth;arrowEndY=newShapeY+newRectHeight/2;break;default:return false;}
newShapeW=newRectWidth;newShapeH=newRectHeight;}else if(shape.type==="circle"||shape.type==="oval"){const cx=shape.x+shape.w/2;const cy=shape.y+shape.h/2;const absW=Math.abs(shape.w);const absH=Math.abs(shape.h);const rx=absW/2;const ry=absH/2;let newCenterX=cx;let newCenterY=cy;switch(side){case"top":newCenterX=cx;newCenterY=cy-ry-offset-ry;arrowStartX=cx;arrowStartY=cy-ry;arrowEndX=newCenterX;arrowEndY=newCenterY+ry;break;case"right":newCenterX=cx+rx+offset+rx;newCenterY=cy;arrowStartX=cx+rx;arrowStartY=cy;arrowEndX=newCenterX-rx;arrowEndY=newCenterY;break;case"bottom":newCenterX=cx;newCenterY=cy+ry+offset+ry;arrowStartX=cx;arrowStartY=cy+ry;arrowEndX=newCenterX;arrowEndY=newCenterY-ry;break;case"left":newCenterX=cx-rx-offset-rx;newCenterY=cy;arrowStartX=cx-rx;arrowStartY=cy;arrowEndX=newCenterX+rx;arrowEndY=newCenterY;break;default:return false;}
newShapeX=newCenterX-rx;newShapeY=newCenterY-ry;newShapeW=shape.w;newShapeH=shape.h;}else{return false;}
const newShapeId=generateId();const newShape={id:newShapeId,type:shape.type,x:newShapeX,y:newShapeY,w:newShapeW,h:newShapeH,color:shape.color||currentColor,fillColor:shape.fillColor||currentFillColor,width:shape.width||currentWidth,};shapes.push(newShape);const newShapeIndex=shapes.length-1;const arrowId=generateId();const arrowMidX=(arrowStartX+arrowEndX)/2;const arrowMidY=(arrowStartY+arrowEndY)/2;const arrow={id:arrowId,type:"arrow",start:{x:arrowStartX,y:arrowStartY},end:{x:arrowEndX,y:arrowEndY},control:{x:arrowMidX,y:arrowMidY},color:shape.color||currentColor,fillColor:shape.fillColor||currentFillColor,width:shape.width||currentWidth,startConnected:attachToShape({x:arrowStartX,y:arrowStartY},shape,idx),endConnected:attachToShape({x:arrowEndX,y:arrowEndY},newShape,newShapeIndex),};shapes.push(arrow);updateConnections();clearSelection();addToSelection(newShapeIndex);hoveredSide=null;hoveredRectIndex=null;saveHistory();render();return true;}
function getPointerPos(e){const rect=canvas.getBoundingClientRect();const clientX=e.touches?e.touches[0]?e.touches[0].clientX:e.changedTouches[0].clientX:e.clientX;const clientY=e.touches?e.touches[0]?e.touches[0].clientY:e.changedTouches[0].clientY:e.clientY;return{x:clientX-rect.left,y:clientY-rect.top};}
function generateId(){return Date.now().toString(36)+Math.random().toString(36).substr(2);}
let initialGroupBounds=null;function getSelectionBounds(){if(selectedIndices.size===0)return null;let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;selectedIndices.forEach((idx)=>{const b=getBoundingBox(shapes[idx]);minX=Math.min(minX,b.x);minY=Math.min(minY,b.y);maxX=Math.max(maxX,b.x+b.w);maxY=Math.max(maxY,b.y+b.h);});if(minX===Infinity)return null;return{x:minX,y:minY,w:maxX-minX,h:maxY-minY};}
function updateFloatingToolbar(){if(selectedIndices.size>0&&currentTool==='select'&&!isDragging&&!isBoxSelecting&&!isManipulatingHandle&&!camera.isPanning){const bounds=getSelectionBounds();if(bounds){const screenPos=toScreen(bounds.x,bounds.y);const screenWidth=bounds.w*camera.scale;const rightX=screenPos.x+screenWidth;const topY=screenPos.y;const offset=10;floatingToolbar.style.transform='translate(0, -100%)';floatingToolbar.style.left=(rightX+offset)+'px';floatingToolbar.style.top=(topY-offset)+'px';floatingToolbar.classList.remove('hidden');floatingToolbar.classList.add('flex');return;}}
floatingToolbar.classList.add('hidden');floatingToolbar.classList.remove('flex');}
function resizeGroup(handle,initBounds,initShapesMap,pos){const dx=pos.x-startPos.x;const dy=pos.y-startPos.y;let newX=initBounds.x;let newY=initBounds.y;let newW=initBounds.w;let newH=initBounds.h;if(handle==="br"){newW=initBounds.w+dx;newH=initBounds.h+dy;}else if(handle==="bl"){newX=initBounds.x+dx;newW=initBounds.w-dx;newH=initBounds.h+dy;}else if(handle==="tr"){newY=initBounds.y+dy;newW=initBounds.w+dx;newH=initBounds.h-dy;}else if(handle==="tl"){newX=initBounds.x+dx;newY=initBounds.y+dy;newW=initBounds.w-dx;newH=initBounds.h-dy;}else if(handle==="top"){newY=initBounds.y+dy;newH=initBounds.h-dy;}else if(handle==="bottom"){newH=initBounds.h+dy;}else if(handle==="left"){newX=initBounds.x+dx;newW=initBounds.w-dx;}else if(handle==="right"){newW=initBounds.w+dx;}
const scaleX=initBounds.w===0?1:newW/initBounds.w;const scaleY=initBounds.h===0?1:newH/initBounds.h;selectedIndices.forEach((idx)=>{const shape=shapes[idx];const initShape=initShapesMap.get(idx);if(!initShape)return;if(shape.type==="pencil"||shape.type==="pencil-arrow"||shape.type==="laser"){shape.points=initShape.points.map((p)=>({x:newX+(p.x-initBounds.x)*scaleX,y:newY+(p.y-initBounds.y)*scaleY,}));}else if(shape.type==="line"||shape.type==="arrow"){shape.start.x=newX+(initShape.start.x-initBounds.x)*scaleX;shape.start.y=newY+(initShape.start.y-initBounds.y)*scaleY;shape.end.x=newX+(initShape.end.x-initBounds.x)*scaleX;shape.end.y=newY+(initShape.end.y-initBounds.y)*scaleY;if(shape.control&&initShape.control){shape.control.x=newX+(initShape.control.x-initBounds.x)*scaleX;shape.control.y=newY+(initShape.control.y-initBounds.y)*scaleY;}}else if(shape.type==="text"){shape.x=newX+(initShape.x-initBounds.x)*scaleX;shape.y=newY+(initShape.y-initBounds.y)*scaleY;shape.size=Math.max(5,Math.abs(initShape.size*scaleY));}else{shape.x=newX+(initShape.x-initBounds.x)*scaleX;shape.y=newY+(initShape.y-initBounds.y)*scaleY;shape.w=initShape.w*scaleX;shape.h=initShape.h*scaleY;}});}
function onMouseDown(e){if(isTyping||isFinishingText)return;const screenPos=getPointerPos(e);const pos=toWorld(screenPos.x,screenPos.y);if(e.button===1||(e.ctrlKey&&e.button===0)){camera.isPanning=true;startPos=screenPos;canvas.style.cursor="grabbing";return;}
if(e.button!==0){return;}
startPos=pos;isDragging=true;if(currentTool==="select"){if(selectedIndices.size===1&&hoveredSide&&hoveredRectIndex!==null){const idx=hoveredRectIndex;const shape=shapes[idx];const iconPos=getPlusIconPosition(shape,hoveredSide);if(iconPos&&isPointOnPlusIcon(pos,iconPos)){if(createLinkedShapeOnSide(hoveredSide)){isDragging=false;return;}
isDragging=false;return;}}
if(selectedIndices.size===1){const idx=selectedIndices.values().next().value;const handle=getHitHandle(pos,shapes[idx]);if(handle){isManipulatingHandle=true;activeHandle=handle;initialShapeState=JSON.parse(JSON.stringify(shapes[idx]));startPos=pos;return;}}else if(selectedIndices.size>1){const groupBounds=getSelectionBounds();if(groupBounds){const dummyShape={x:groupBounds.x,y:groupBounds.y,w:groupBounds.w,h:groupBounds.h,type:"group_selection",};const handle=getHitHandle(pos,dummyShape);if(handle){isManipulatingHandle=true;activeHandle=handle;initialGroupBounds=groupBounds;initialShapeState=new Map();selectedIndices.forEach((idx)=>{initialShapeState.set(idx,JSON.parse(JSON.stringify(shapes[idx])));});startPos=pos;return;}}}
let hitIndex=-1;for(let i=shapes.length-1;i>=0;i--){if(isPointInShape(pos,shapes[i])){hitIndex=i;break;}}
if(hitIndex!==-1){if(e.altKey){if(!selectedIndices.has(hitIndex)){selectedIndices.forEach((idx)=>restoreConnectionsForShape(shapes[idx]));clearSelection();addToSelection(hitIndex);}
const duplicatedShapes=[];const oldToNewIndexMap=new Map();selectedIndices.forEach((idx)=>{const original=shapes[idx];const duplicate=JSON.parse(JSON.stringify(original,(key,value)=>{if(key==="image")return undefined;return value;}));duplicate.id=generateId();if(original.type==="image"&&original.src){const img=new Image();img.src=original.src;duplicate.image=img;}
duplicatedShapes.push(duplicate);oldToNewIndexMap.set(idx,shapes.length+duplicatedShapes.length-1);});shapes.push(...duplicatedShapes);clearSelection();for(let i=shapes.length-duplicatedShapes.length;i<shapes.length;i++){addToSelection(i);}
isDuplicating=true;isMovingSelection=true;moveOffset=pos;selectedIndices.forEach((idx)=>temporarilyBreakConnections(shapes[idx]));}
else if(e.shiftKey){if(selectedIndices.has(hitIndex)){removeFromSelection(hitIndex);isMovingSelection=false;restoreConnectionsForShape(shapes[hitIndex]);}else{addToSelection(hitIndex);isMovingSelection=true;moveOffset=pos;temporarilyBreakConnections(shapes[hitIndex]);}}else{const wasAlreadySelected=selectedIndices.has(hitIndex);if(!wasAlreadySelected){selectedIndices.forEach((idx)=>restoreConnectionsForShape(shapes[idx]));clearSelection();addToSelection(hitIndex);}
isMovingSelection=true;moveOffset=pos;selectedIndices.forEach((idx)=>temporarilyBreakConnections(shapes[idx]));}}else{let handled=false;if(selectedIndices.size>1&&!e.shiftKey){const bounds=getSelectionBounds();if(bounds&&pos.x>=bounds.x&&pos.x<=bounds.x+bounds.w&&pos.y>=bounds.y&&pos.y<=bounds.y+bounds.h){handled=true;if(e.altKey){const duplicatedShapes=[];selectedIndices.forEach((idx)=>{const original=shapes[idx];const duplicate=JSON.parse(JSON.stringify(original,(key,value)=>{if(key==="image")return undefined;return value;}));duplicate.id=generateId();if(original.type==="image"&&original.src){const img=new Image();img.src=original.src;duplicate.image=img;}
duplicatedShapes.push(duplicate);});shapes.push(...duplicatedShapes);clearSelection();for(let i=shapes.length-duplicatedShapes.length;i<shapes.length;i++){addToSelection(i);}
isDuplicating=true;}
isMovingSelection=true;moveOffset=pos;selectedIndices.forEach((idx)=>temporarilyBreakConnections(shapes[idx]));}}
if(!handled){if(!e.shiftKey){selectedIndices.forEach((idx)=>restoreConnectionsForShape(shapes[idx]));clearSelection();}
isBoxSelecting=true;selectionBox={start:pos,end:pos};}}
render();}
else if(currentTool==="eraser"){handleEraser(pos);}else if(currentTool==="text"){createTextInput(pos.x,pos.y);isDragging=false;}else{clearSelection();const newId=generateId();let startConn=null;if(currentTool==="line"||currentTool==="arrow"||currentTool==="pencil"||currentTool==="pencil-arrow"){for(let i=shapes.length-1;i>=0;i--){if(isPointInShape(pos,shapes[i])){startConn=attachToShape(pos,shapes[i],i);connectionHoverShape=shapes[i];break;}}
render();}
hideShapeRecognitionPanel();if(currentTool==="pencil"){currentShape={id:newId,type:"pencil",points:[pos],color:currentColor,fillColor:currentFillColor,width:currentWidth,startConnected:startConn,};}else if(currentTool==="pencil-arrow"){currentShape={id:newId,type:"pencil-arrow",points:[pos],color:currentColor,fillColor:currentFillColor,width:currentWidth,startConnected:startConn,hasEndArrow:true,};}else if(currentTool==="laser"){currentShape={id:newId,type:"laser",points:[pos],color:"#ff0000",width:currentWidth,createdAt:Date.now(),};}else if(currentTool==="line"){currentShape={id:newId,type:"line",start:pos,end:pos,color:currentColor,fillColor:currentFillColor,width:currentWidth,startConnected:startConn,};}else if(currentTool==="arrow"){arrowCreationPhase="drawing_line";currentShape={id:newId,type:"arrow",start:pos,end:pos,control:pos,color:currentColor,fillColor:currentFillColor,width:currentWidth,startConnected:startConn,hasEndArrow:true,};}else{currentShape={id:newId,type:currentTool,x:pos.x,y:pos.y,w:0,h:0,color:currentColor,fillColor:currentFillColor,width:currentWidth,};}}}
function onMouseMove(e){const screenPos=getPointerPos(e);const pos=toWorld(screenPos.x,screenPos.y);if(camera.isPanning){const dx=screenPos.x-startPos.x;const dy=screenPos.y-startPos.y;camera.x+=dx;camera.y+=dy;startPos=screenPos;render();return;}
if(currentTool==="select"&&!isDragging&&selectedIndices.size>0){let handle=null;let activeShape=null;let idx=null;if(selectedIndices.size===1){idx=selectedIndices.values().next().value;activeShape=shapes[idx];handle=getHitHandle(pos,activeShape);}else{const groupBounds=getSelectionBounds();if(groupBounds){handle=getHitHandle(pos,{x:groupBounds.x,y:groupBounds.y,w:groupBounds.w,h:groupBounds.h,type:"group_selection",});}}
if(handle){if(handle==="tl"||handle==="br"){canvas.style.cursor="nwse-resize";}else if(handle==="tr"||handle==="bl"){canvas.style.cursor="nesw-resize";}else if(handle==="top"||handle==="bottom"){canvas.style.cursor="ns-resize";}else if(handle==="left"||handle==="right"){canvas.style.cursor="ew-resize";}else if(handle==="start"||handle==="end"||handle==="control"){canvas.style.cursor="move";}
hoveredSide=null;hoveredRectIndex=null;}else if(activeShape){if(activeShape&&(activeShape.type==="rect"||activeShape.type==="circle"||activeShape.type==="oval"||activeShape.type==="rhombus"||activeShape.type==="diamond")){const side=detectHoveredSide(pos,activeShape);if(side){hoveredSide=side;hoveredRectIndex=idx;canvas.style.cursor="pointer";render();}else if(hoveredSide!==null&&hoveredRectIndex===idx){const iconPos=getPlusIconPosition(activeShape,hoveredSide);if(iconPos&&isPointOnPlusIcon(pos,iconPos)){canvas.style.cursor="pointer";}else{hoveredSide=null;hoveredRectIndex=null;canvas.style.cursor="default";render();}}else{if(hoveredSide!==null||hoveredRectIndex!==null){hoveredSide=null;hoveredRectIndex=null;render();}
canvas.style.cursor="default";}}else{if(hoveredSide!==null||hoveredRectIndex!==null){hoveredSide=null;hoveredRectIndex=null;render();}
canvas.style.cursor="default";}}else{if(selectedIndices.size>1){const groupBounds=getSelectionBounds();if(groupBounds&&pos.x>=groupBounds.x&&pos.x<=groupBounds.x+groupBounds.w&&pos.y>=groupBounds.y&&pos.y<=groupBounds.y+groupBounds.h){canvas.style.cursor="move";}else{canvas.style.cursor="default";}}else{canvas.style.cursor="default";}}}else if(currentTool!=="select"||isDragging){if(!isDragging&&currentTool!=="select"){updateCursor();}
if(hoveredSide!==null||hoveredRectIndex!==null){hoveredSide=null;hoveredRectIndex=null;render();}}else{if(hoveredSide!==null||hoveredRectIndex!==null){hoveredSide=null;hoveredRectIndex=null;render();}}
if(currentTool==="line"||currentTool==="arrow"||currentTool==="pencil"||currentTool==="pencil-arrow"){let foundHover=false;for(let i=shapes.length-1;i>=0;i--){if(isPointInShape(pos,shapes[i])){if(connectionHoverShape!==shapes[i]){connectionHoverShape=shapes[i];render();}
foundHover=true;break;}}
if(!foundHover&&connectionHoverShape!==null){connectionHoverShape=null;render();}}
if(!isDragging)return;e.preventDefault();if(currentTool==="select"){if(isManipulatingHandle){if(selectedIndices.size>1){resizeGroup(activeHandle,initialGroupBounds,initialShapeState,pos);}else{const idx=selectedIndices.values().next().value;const shape=shapes[idx];resizeShape(shape,initialShapeState,pos);}
updateConnections();}else if(isMovingSelection){const dx=pos.x-moveOffset.x;const dy=pos.y-moveOffset.y;selectedIndices.forEach((idx)=>moveShape(shapes[idx],dx,dy));moveOffset=pos;updateConnections();}else if(isBoxSelecting){selectionBox.end=pos;}
render();}else if(currentTool==="eraser"){handleEraser(pos);}else if(currentShape){if(currentTool==="arrow"&&arrowCreationPhase==="drawing_line"){currentShape.end=pos;currentShape.control={x:(currentShape.start.x+pos.x)/2,y:(currentShape.start.y+pos.y)/2,};}else if(currentShape.type==="pencil"||currentShape.type==="pencil-arrow"){const lastPt=currentShape.points[currentShape.points.length-1];if(lastPt){const dist=Math.hypot(pos.x-lastPt.x,pos.y-lastPt.y);if(dist>5/camera.scale){currentShape.points.push(pos);}}else{currentShape.points.push(pos);}}else if(currentShape.type==="laser"){const lastPt=currentShape.points[currentShape.points.length-1];if(lastPt){const dist=Math.hypot(pos.x-lastPt.x,pos.y-lastPt.y);if(dist>1/camera.scale){currentShape.points.push(pos);if(currentShape.points.length>LASER_MAX_TAIL){currentShape.points.shift();}}}else{currentShape.points.push(pos);}}else if(currentShape.type==="line"){currentShape.end=pos;}else{currentShape.w=pos.x-startPos.x;currentShape.h=pos.y-startPos.y;}
render();}}
function detectShapeType(pencilShape){if(!pencilShape.points||pencilShape.points.length<4){return null;}
const points=pencilShape.points;const firstPt=points[0];const lastPt=points[points.length-1];let minX=points[0].x,maxX=points[0].x;let minY=points[0].y,maxY=points[0].y;points.forEach((p)=>{minX=Math.min(minX,p.x);maxX=Math.max(maxX,p.x);minY=Math.min(minY,p.y);maxY=Math.max(maxY,p.y);});const width=maxX-minX;const height=maxY-minY;const shapeSize=Math.max(width,height);const closureDist=Math.hypot(lastPt.x-firstPt.x,lastPt.y-firstPt.y);const closureThreshold=Math.max(15,shapeSize*0.15);const isClosedShape=closureDist<closureThreshold;if(!isClosedShape)return null;const centerX=minX+width/2;const centerY=minY+height/2;let sumDistFromCenter=0;points.forEach((p)=>{sumDistFromCenter+=Math.hypot(p.x-centerX,p.y-centerY);});const avgDistFromCenter=sumDistFromCenter/points.length;let radiusVariance=0;points.forEach((p)=>{const dist=Math.hypot(p.x-centerX,p.y-centerY);radiusVariance+=Math.pow(dist-avgDistFromCenter,2);});radiusVariance=Math.sqrt(radiusVariance/points.length);const radiusVarianceRatio=radiusVariance/avgDistFromCenter;const corners=[];const step=Math.max(1,Math.floor(points.length/80));for(let i=step*2;i<points.length-step*2;i+=step){const prev=points[i-step*2];const curr=points[i];const next=points[i+step*2];const v1={x:curr.x-prev.x,y:curr.y-prev.y};const v2={x:next.x-curr.x,y:next.y-curr.y};const len1=Math.hypot(v1.x,v1.y);const len2=Math.hypot(v2.x,v2.y);if(len1>1&&len2>1){const norm1={x:v1.x/len1,y:v1.y/len1};const norm2={x:v2.x/len2,y:v2.y/len2};const dot=norm1.x*norm2.x+norm1.y*norm2.y;if(dot<-0.1){corners.push({x:curr.x,y:curr.y,angle:dot});}}}
const filteredCorners=[];const minCornerDistance=Math.max(10,Math.min(width,height)*0.12);corners.forEach((corner)=>{let isNearExisting=false;for(let existing of filteredCorners){if(Math.hypot(corner.x-existing.x,corner.y-existing.y)<minCornerDistance){isNearExisting=true;break;}}
if(!isNearExisting){filteredCorners.push(corner);}});const cornerCount=filteredCorners.length;if(radiusVarianceRatio<0.12){return{type:"circle",confidence:0.9};}
const edgeThreshold=Math.max(10,Math.min(width,height)*0.2);let pointsNearEdges=0;points.forEach((p)=>{const distToLeft=Math.abs(p.x-minX);const distToRight=Math.abs(p.x-maxX);const distToTop=Math.abs(p.y-minY);const distToBottom=Math.abs(p.y-maxY);if(distToLeft<edgeThreshold||distToRight<edgeThreshold||distToTop<edgeThreshold||distToBottom<edgeThreshold){pointsNearEdges++;}});const edgeAlignmentRatio=pointsNearEdges/points.length;const aspectRatio=Math.max(width,height)/Math.min(width,height);const minSize=20;if(shapeSize>=minSize&&cornerCount>=2&&cornerCount<=8&&edgeAlignmentRatio>=0.5&&aspectRatio<10.0){if(aspectRatio>3.0&&cornerCount<3){return null;}
if(cornerCount===4){return{type:"rectangle",confidence:0.95};}else if(cornerCount===3||cornerCount===5){return{type:"rectangle",confidence:0.85};}else if(cornerCount===2||cornerCount===6){return{type:"rectangle",confidence:0.75};}else{return{type:"rectangle",confidence:0.65};}}
if(shapeSize>=minSize&&edgeAlignmentRatio>=0.7&&aspectRatio<10.0&&cornerCount>=0&&Math.min(width,height)>25){return{type:"rectangle",confidence:0.8};}
return null;}
function convertPencilToShape(pencilShape,detectedShape){const points=pencilShape.points;let minX=points[0].x,maxX=points[0].x;let minY=points[0].y,maxY=points[0].y;points.forEach((p)=>{minX=Math.min(minX,p.x);maxX=Math.max(maxX,p.x);minY=Math.min(minY,p.y);maxY=Math.max(maxY,p.y);});const width=maxX-minX;const height=maxY-minY;const shapeTypeMap={rectangle:"rect",circle:"circle",triangle:"triangle",};const mappedType=shapeTypeMap[detectedShape.type]||detectedShape.type;const newShape={id:generateId(),type:mappedType,x:minX,y:minY,w:width,h:height,color:pencilShape.color,fillColor:"transparent",width:pencilShape.width,startConnected:pencilShape.startConnected,endConnected:pencilShape.endConnected,};return newShape;}
function showShapeConversionPrompt(pencilShape,detectedShape){const overlay=document.createElement("div");overlay.id="conversion-overlay";overlay.style.cssText=`position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:999;`;const modal=document.createElement("div");modal.style.cssText=`background:white;padding:24px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.2);max-width:400px;text-align:center;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;`;const shapeNameMap={circle:"Circle",rectangle:"Rectangle",triangle:"Triangle",};const title=document.createElement("h2");title.textContent="Convert to Shape?";title.style.cssText="margin: 0 0 12px 0; font-size: 20px; color: #1f2937;";modal.appendChild(title);const message=document.createElement("p");message.textContent=`Looks like you drew a ${shapeNameMap[detectedShape.type]}!Would you like to convert it to a shape?`;message.style.cssText="margin: 0 0 20px 0; font-size: 14px; color: #6b7280; line-height: 1.5;";modal.appendChild(message);const confidence=document.createElement("p");confidence.textContent=`Confidence:${Math.round(detectedShape.confidence*100)}%`;confidence.style.cssText="margin: 0 0 20px 0; font-size: 12px; color: #9ca3af;";modal.appendChild(confidence);const buttonContainer=document.createElement("div");buttonContainer.style.cssText="display: flex; gap: 12px; justify-content: center;";const cancelBtn=document.createElement("button");cancelBtn.textContent="Keep as Drawing";cancelBtn.style.cssText=`padding:8px 16px;border:1px solid#d1d5db;background:white;border-radius:6px;cursor:pointer;font-size:14px;color:#6b7280;transition:all 0.2s;`;cancelBtn.onmouseover=()=>(cancelBtn.style.background="#f9fafb");cancelBtn.onmouseout=()=>(cancelBtn.style.background="white");cancelBtn.onclick=()=>{overlay.remove();};buttonContainer.appendChild(cancelBtn);const convertBtn=document.createElement("button");convertBtn.textContent="Convert";convertBtn.style.cssText=`padding:8px 16px;border:none;background:#3b82f6;color:white;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.2s;`;convertBtn.onmouseover=()=>(convertBtn.style.background="#2563eb");convertBtn.onmouseout=()=>(convertBtn.style.background="#3b82f6");convertBtn.onclick=()=>{const pencilIndex=shapes.indexOf(pencilShape);if(pencilIndex>-1){shapes.splice(pencilIndex,1);}
const newShape=convertPencilToShape(pencilShape,detectedShape);shapes.push(newShape);clearSelection();addToSelection(shapes.length-1);saveHistory();render();showToast(`Converted to ${shapeNameMap[detectedShape.type]}`);overlay.remove();};buttonContainer.appendChild(convertBtn);modal.appendChild(buttonContainer);overlay.appendChild(modal);document.body.appendChild(overlay);}
function onMouseUp(e){connectionHoverShape=null;if(camera.isPanning){camera.isPanning=false;updateCursor();return;}
if(!isDragging)return;isDragging=false;const screenPos=getPointerPos(e);const pos=toWorld(screenPos.x,screenPos.y);if(isBoxSelecting){finishBoxSelection();isBoxSelecting=false;render();}else if(isMovingSelection||isManipulatingHandle){if(isMovingSelection){selectedIndices.forEach((idx)=>{const shape=shapes[idx];reEvaluateConnections(shape);});if(isDuplicating){const count=selectedIndices.size;showToast(`Duplicated ${count}object${count!==1?"s":""}`);isDuplicating=false;}}
saveHistory();isMovingSelection=false;isManipulatingHandle=false;activeHandle=null;render();}
if(currentShape){if(currentTool==="arrow"&&arrowCreationPhase==="drawing_line"){const pos=toWorld(getPointerPos(e).x,getPointerPos(e).y);for(let i=shapes.length-1;i>=0;i--){if(isPointInShape(pos,shapes[i])){currentShape.endConnected=attachToShape(pos,shapes[i],i);break;}}
arrowCreationPhase="idle";shapes.push(currentShape);saveHistory();setTool("select");clearSelection();addToSelection(shapes.length-1);currentShape=null;render();return;}
if(currentTool==="line"||currentTool==="pencil"||currentTool==="pencil-arrow"){const pos=getPointerPos(e);for(let i=shapes.length-1;i>=0;i--){if(isPointInShape(pos,shapes[i])){currentShape.endConnected=attachToShape(pos,shapes[i],i);break;}}}
const isTiny=currentShape.type==="pencil"||currentShape.type==="pencil-arrow"?currentShape.points.length<2:currentShape.type==="laser"?currentShape.points.length<2:currentShape.type==="line"?Math.hypot(currentShape.end.x-currentShape.start.x,currentShape.end.y-currentShape.start.y)<5:Math.abs(currentShape.w)<5&&Math.abs(currentShape.h)<5;if(!isTiny){if(currentShape.type==="laser"){const laserShape=currentShape;laserShape.deletedCount=0;laserShapes.push(laserShape);const startTime=Date.now();const fadeInterval=setInterval(()=>{const elapsed=Date.now()-startTime;if(elapsed>=LASER_LIFETIME){const index=laserShapes.indexOf(laserShape);if(index>-1){laserShapes.splice(index,1);}
clearInterval(fadeInterval);render();}else if(elapsed>LASER_DELETE_DELAY){const deleteElapsed=elapsed-LASER_DELETE_DELAY;const deleteProgress=Math.min(1,deleteElapsed/LASER_DELETE_DURATION);const pointsToDelete=Math.floor(laserShape.points.length*deleteProgress);laserShape.deletedCount=pointsToDelete;laserShape.tailOpacity=1-deleteProgress;render();}else{laserShape.deletedCount=0;laserShape.tailOpacity=1;render();}},16);}else{if(currentShape.type==="pencil"||currentShape.type==="pencil-arrow"){const detectedShape=detectShapeType(currentShape);if(detectedShape){const newShape=convertPencilToShape(currentShape,detectedShape);shapes.push(newShape);const convertedIndex=shapes.length-1;clearSelection();addToSelection(convertedIndex);saveHistory();render();showShapeRecognitionPanel(currentShape,convertedIndex);}else{shapes.push(currentShape);saveHistory();}}else{shapes.push(currentShape);clearSelection();selectedIndices.add(shapes.length-1);setTool("select",true);saveHistory();}}}
currentShape=null;render();}}
function temporarilyBreakConnections(shape){if(!shape||(shape.type!=="arrow"&&shape.type!=="line"&&shape.type!=="pencil"&&shape.type!=="pencil-arrow")){return;}
if(!temporarilyDisconnectedShapes.has(shape.id)){temporarilyDisconnectedShapes.set(shape.id,{startConnected:shape.startConnected,endConnected:shape.endConnected,});shape.startConnected=null;shape.endConnected=null;}}
function restoreConnectionsForShape(shape){if(!shape)return;const stored=temporarilyDisconnectedShapes.get(shape.id);if(stored){shape.startConnected=stored.startConnected;shape.endConnected=stored.endConnected;temporarilyDisconnectedShapes.delete(shape.id);}}
function reEvaluateConnections(shape){if(!shape||(shape.type!=="arrow"&&shape.type!=="line"&&shape.type!=="pencil"&&shape.type!=="pencil-arrow")){return;}
let startPos,endPos;if(shape.type==="pencil"||shape.type==="pencil-arrow"){if(shape.points.length===0)return;startPos=shape.points[0];endPos=shape.points[shape.points.length-1];}else{startPos=shape.start;endPos=shape.end;}
let foundStart=false;for(let i=shapes.length-1;i>=0;i--){if(shapes[i].id===shape.id)continue;if(isPointInShape(startPos,shapes[i])){shape.startConnected=attachToShape(startPos,shapes[i],i);foundStart=true;break;}}
if(!foundStart){shape.startConnected=null;}
let foundEnd=false;for(let i=shapes.length-1;i>=0;i--){if(shapes[i].id===shape.id)continue;if(isPointInShape(endPos,shapes[i])){shape.endConnected=attachToShape(endPos,shapes[i],i);foundEnd=true;break;}}
if(!foundEnd){shape.endConnected=null;}
temporarilyDisconnectedShapes.delete(shape.id);}
function attachToShape(pos,shape,index){const b=getBoundingBox(shape);const u=(pos.x-b.x)/Math.max(1,b.w);const v=(pos.y-b.y)/Math.max(1,b.h);return{id:shape.id,u,v};}
function getEdgeConnectionPoint(shape,directionX,directionY){const b=getBoundingBox(shape);const centerX=b.x+b.w/2;const centerY=b.y+b.h/2;const dx=directionX-centerX;const dy=directionY-centerY;if(shape.type==="circle"){const rx=b.w/2;const ry=b.h/2;if(dx===0&&dy===0){return{x:centerX+rx,y:centerY};}
const angle=Math.atan2(dy,dx);return{x:centerX+rx*Math.cos(angle),y:centerY+ry*Math.sin(angle),};}else{if(dx===0&&dy===0){return{x:b.x+b.w,y:centerY};}
let t=Infinity;let edgePoint={x:centerX,y:centerY};if(dx>0){const tRight=(b.x+b.w-centerX)/dx;const yIntersect=centerY+tRight*dy;if(yIntersect>=b.y&&yIntersect<=b.y+b.h&&tRight<t){t=tRight;edgePoint={x:b.x+b.w,y:yIntersect};}}
if(dx<0){const tLeft=(b.x-centerX)/dx;const yIntersect=centerY+tLeft*dy;if(yIntersect>=b.y&&yIntersect<=b.y+b.h&&tLeft<t){t=tLeft;edgePoint={x:b.x,y:yIntersect};}}
if(dy>0){const tBottom=(b.y+b.h-centerY)/dy;const xIntersect=centerX+tBottom*dx;if(xIntersect>=b.x&&xIntersect<=b.x+b.w&&tBottom<t){t=tBottom;edgePoint={x:xIntersect,y:b.y+b.h};}}
if(dy<0){const tTop=(b.y-centerY)/dy;const xIntersect=centerX+tTop*dx;if(xIntersect>=b.x&&xIntersect<=b.x+b.w&&tTop<t){t=tTop;edgePoint={x:xIntersect,y:b.y};}}
return edgePoint;}}
function updateConnections(){const shapeMap=new Map();shapes.forEach((s)=>shapeMap.set(s.id,s));shapes.forEach((shape)=>{if(temporarilyDisconnectedShapes.has(shape.id)){return;}
if(shape.type==="line"||shape.type==="arrow"||shape.type==="pencil"||shape.type==="pencil-arrow"){const startTarget=shape.startConnected?shapeMap.get(shape.startConnected.id):null;const endTarget=shape.endConnected?shapeMap.get(shape.endConnected.id):null;let startPoint=null;let endPoint=null;if(startTarget&&endTarget){const startBox=getBoundingBox(startTarget);const endBox=getBoundingBox(endTarget);const startCenterX=startBox.x+startBox.w/2;const startCenterY=startBox.y+startBox.h/2;const endCenterX=endBox.x+endBox.w/2;const endCenterY=endBox.y+endBox.h/2;startPoint=getEdgeConnectionPoint(startTarget,endCenterX,endCenterY);endPoint=getEdgeConnectionPoint(endTarget,startCenterX,startCenterY);}else if(startTarget){let directionPos;if(shape.type==="pencil"||shape.type==="pencil-arrow"){directionPos=shape.points[shape.points.length-1];}else if(shape.type==="arrow"&&shape.control){directionPos=shape.control;}else{directionPos=shape.end;}
startPoint=getEdgeConnectionPoint(startTarget,directionPos.x,directionPos.y);}else if(endTarget){let directionPos;if(shape.type==="pencil"||shape.type==="pencil-arrow"){directionPos=shape.points[0];}else if(shape.type==="arrow"&&shape.control){directionPos=shape.control;}else{directionPos=shape.start;}
endPoint=getEdgeConnectionPoint(endTarget,directionPos.x,directionPos.y);}
if(startPoint&&startTarget){if(shape.type==="pencil"||shape.type==="pencil-arrow"){const dx=startPoint.x-shape.points[0].x;const dy=startPoint.y-shape.points[0].y;const range=Math.min(shape.points.length,12);for(let i=0;i<range;i++){const influence=1-i/range;shape.points[i].x+=dx*influence;shape.points[i].y+=dy*influence;}}else{shape.start.x=startPoint.x;shape.start.y=startPoint.y;}
const b=getBoundingBox(startTarget);shape.startConnected.u=(startPoint.x-b.x)/Math.max(1,b.w);shape.startConnected.v=(startPoint.y-b.y)/Math.max(1,b.h);}else if(shape.startConnected&&!startTarget){shape.startConnected=null;}
if(endPoint&&endTarget){if(shape.type==="pencil"||shape.type==="pencil-arrow"){const last=shape.points.length-1;const dx=endPoint.x-shape.points[last].x;const dy=endPoint.y-shape.points[last].y;const range=Math.min(shape.points.length,12);for(let i=0;i<range;i++){const idx=last-i;const influence=1-i/range;shape.points[idx].x+=dx*influence;shape.points[idx].y+=dy*influence;}}else{shape.end.x=endPoint.x;shape.end.y=endPoint.y;}
const b=getBoundingBox(endTarget);shape.endConnected.u=(endPoint.x-b.x)/Math.max(1,b.w);shape.endConnected.v=(endPoint.y-b.y)/Math.max(1,b.h);}else if(shape.endConnected&&!endTarget){shape.endConnected=null;}
if(shape.type==="arrow"&&shape.control&&startPoint&&endPoint&&startTarget&&endTarget){shape.control.x=(startPoint.x+endPoint.x)/2;shape.control.y=(startPoint.y+endPoint.y)/2;}}});}
function hasConnections(shape){if(shape.type==="line"||shape.type==="arrow"||shape.type==="pencil"||shape.type==="pencil-arrow"){if(shape.startConnected||shape.endConnected){return true;}}
for(let i=0;i<shapes.length;i++){const s=shapes[i];if(s.id===shape.id)continue;if(s.type==="line"||s.type==="arrow"||s.type==="pencil"||s.type==="pencil-arrow"){if((s.startConnected&&s.startConnected.id===shape.id)||(s.endConnected&&s.endConnected.id===shape.id)){return true;}}}
return false;}
function alignSelected(mode){if(selectedIndices.size<2)return;let anchorIdx;if(selectionQueue.length>0){anchorIdx=selectionQueue[selectionQueue.length-1];}else{const indices=Array.from(selectedIndices);anchorIdx=indices[indices.length-1];}
const anchorShape=shapes[anchorIdx];const anchorBox=getBoundingBox(anchorShape);const anchorX=Math.min(anchorBox.x,anchorBox.x+anchorBox.w);const anchorY=Math.min(anchorBox.y,anchorBox.y+anchorBox.h);const anchorW=Math.abs(anchorBox.w);const anchorH=Math.abs(anchorBox.h);let refLeft=anchorX;let refRight=anchorX+anchorW;let refTop=anchorY;let refBottom=anchorY+anchorH;let refCenterH=anchorX+anchorW/2;let refMiddleV=anchorY+anchorH/2;selectedIndices.forEach((idx)=>{if(idx===anchorIdx)return;const shape=shapes[idx];if(hasConnections(shape))return;const b=getBoundingBox(shape);const bx=Math.min(b.x,b.x+b.w);const by=Math.min(b.y,b.y+b.h);const bw=Math.abs(b.w);const bh=Math.abs(b.h);let dx=0;let dy=0;if(mode==="left")dx=refLeft-bx;else if(mode==="center-h")dx=refCenterH-(bx+bw/2);else if(mode==="right")dx=refRight-(bx+bw);else if(mode==="top")dy=refTop-by;else if(mode==="middle-v")dy=refMiddleV-(by+bh/2);else if(mode==="bottom")dy=refBottom-(by+bh);moveShape(shape,dx,dy);});updateConnections();render();saveHistory();}
function moveShape(shape,dx,dy){if(shape.type==="pencil"||shape.type==="pencil-arrow"){shape.points.forEach((p)=>{p.x+=dx;p.y+=dy;});}else if(shape.type==="line"||shape.type==="arrow"){shape.start.x+=dx;shape.start.y+=dy;shape.end.x+=dx;shape.end.y+=dy;if(shape.control){shape.control.x+=dx;shape.control.y+=dy;}}else{shape.x+=dx;shape.y+=dy;}}
function resizeShape(shape,init,pos){if(activeHandle==="bend"){if(shape.hasEndArrow===undefined){shape.hasEndArrow=false;}
shape.type="arrow";shape.control=pos;activeHandle="control";return;}
if(shape.type==="arrow"||shape.type==="line"){if(activeHandle==="start")shape.start=pos;else if(activeHandle==="end")shape.end=pos;else if(activeHandle==="control")shape.control=pos;return;}
let initX=init.x;let initY=init.y;let initW=init.w;let initH=init.h;if(shape.type==="text"||shape.type==="pencil"||shape.type==="pencil-arrow"||shape.type==="image"){const b=getBoundingBox(init);initX=b.x;initY=b.y;initW=b.w;initH=b.h;}
const dx=pos.x-startPos.x;const dy=pos.y-startPos.y;let newX=initX,newY=initY,newW=initW,newH=initH;if(activeHandle==="br"){newW=initW+dx;newH=initH+dy;}else if(activeHandle==="bl"){newX=initX+dx;newW=initW-dx;newH=initH+dy;}else if(activeHandle==="tr"){newY=initY+dy;newW=initW+dx;newH=initH-dy;}else if(activeHandle==="tl"){newX=initX+dx;newY=initY+dy;newW=initW-dx;newH=initH-dy;}else if(activeHandle==="top"){newY=initY+dy;newH=initH-dy;}else if(activeHandle==="bottom"){newH=initH+dy;}else if(activeHandle==="left"){newX=initX+dx;newW=initW-dx;}else if(activeHandle==="right"){newW=initW+dx;}
if(shape.type==="text"){if(newH<5){newH=5;if(activeHandle.includes("t"))newY=initY+initH-5;}
shape.size=Math.abs(newH);shape.x=newX;shape.y=newY;}else if(shape.type==="pencil"||shape.type==="pencil-arrow"){const scaleX=initW===0?1:newW/initW;const scaleY=initH===0?1:newH/initH;shape.points=init.points.map((p)=>({x:newX+(p.x-initX)*scaleX,y:newY+(p.y-initY)*scaleY,}));}else if(shape.type==="image"){if(shape.aspectRatio){if(activeHandle==="br"){newH=newW/shape.aspectRatio;}else if(activeHandle==="bl"){newH=(initW-dx)/shape.aspectRatio;newW=initW-dx;newX=initX+dx;}else if(activeHandle==="tr"){newH=newW/shape.aspectRatio;newY=initY+initH-newH;}else if(activeHandle==="tl"){newW=initW-dx;newH=newW/shape.aspectRatio;newX=initX+dx;newY=initY+initH-newH;}else if(activeHandle==="top"||activeHandle==="bottom"){newW=Math.abs(newH*shape.aspectRatio);const centerX=initX+initW/2;newX=centerX-newW/2;}else if(activeHandle==="left"||activeHandle==="right"){newH=Math.abs(newW/shape.aspectRatio);const centerY=initY+initH/2;newY=centerY-newH/2;}}
shape.x=newX;shape.y=newY;shape.w=newW;shape.h=newH;}else{shape.x=newX;shape.y=newY;shape.w=newW;shape.h=newH;}}
function finishBoxSelection(){if(!selectionBox)return;const x1=Math.min(selectionBox.start.x,selectionBox.end.x);const x2=Math.max(selectionBox.start.x,selectionBox.end.x);const y1=Math.min(selectionBox.start.y,selectionBox.end.y);const y2=Math.max(selectionBox.start.y,selectionBox.end.y);shapes.forEach((shape,index)=>{const b=getBoundingBox(shape);const bx=Math.min(b.x,b.x+b.w);const by=Math.min(b.y,b.y+b.h);const bw=Math.abs(b.w);const bh=Math.abs(b.h);if(bx<x2&&bx+bw>x1&&by<y2&&by+bh>y1){addToSelection(index);}});selectionBox=null;}
function createTextInput(x,y,text="",size=null,color=null){if(activeInput)cleanupInput();isTyping=true;const input=document.createElement("input");input.type="text";input.id="text-input";const screenPos=toScreen(x,y);input.style.left=screenPos.x+"px";input.style.top=screenPos.y+"px";const useColor=color||currentColor;const useSize=size||currentWidth*5+10;const displaySize=useSize*camera.scale;input.style.color=useColor;input.style.fontSize=displaySize+"px";input.style.lineHeight="1";input.value=text;document.body.appendChild(input);const updateInputWidth=()=>{const measureSpan=document.createElement("span");measureSpan.style.font=`bold ${displaySize}px'Caveat',cursive`;measureSpan.style.visibility="hidden";measureSpan.style.position="absolute";measureSpan.style.whiteSpace="pre";measureSpan.textContent=input.value||" ";document.body.appendChild(measureSpan);const textWidth=measureSpan.offsetWidth;document.body.removeChild(measureSpan);input.style.width=Math.max(50,textWidth+10)+"px";};updateInputWidth();input.addEventListener("input",updateInputWidth);setTimeout(()=>{input.focus();if(text)input.select();},10);activeInput=input;const finish=()=>{if(!activeInput)return;if(input.value.trim()!==""){shapes.push({id:generateId(),type:"text",x:x,y:y,text:input.value,size:useSize,color:useColor,fillColor:currentFillColor,width:1,});clearSelection();addToSelection(shapes.length-1);setTool("select",true);saveHistory();render();}
cleanupInput();};input.addEventListener("keydown",(e)=>{if(e.key==="Enter")finish();});input.addEventListener("blur",finish);}
function cleanupInput(){if(activeInput){activeInput.remove();activeInput=null;}
isTyping=false;isFinishingText=true;setTimeout(()=>{isFinishingText=false;},200);}
function createTextInputForShape(x,y,text="",size=null,color=null,shapeIndex=-1){if(activeInput)cleanupInput();if(shapeIndex>=0&&shapeIndex<shapes.length){shapes[shapeIndex].isEditingText=true;render();}
isTyping=true;const input=document.createElement("input");input.type="text";input.id="text-input";const screenPos=toScreen(x,y);const useColor=color||currentColor;const useSize=size||currentWidth*5+10;const displaySize=useSize*camera.scale;input.style.color=useColor;input.style.fontSize=displaySize+"px";input.style.lineHeight="1";input.style.textAlign="center";input.value=text;input.style.left=screenPos.x+"px";input.style.top=screenPos.y+"px";input.style.transform="translate(-50%, -50%)";document.body.appendChild(input);const updateInputWidth=()=>{const measureSpan=document.createElement("span");measureSpan.style.font=`bold ${displaySize}px'Caveat',cursive`;measureSpan.style.visibility="hidden";measureSpan.style.position="absolute";measureSpan.style.whiteSpace="pre";measureSpan.textContent=input.value||" ";document.body.appendChild(measureSpan);const textWidth=measureSpan.offsetWidth;document.body.removeChild(measureSpan);input.style.width=Math.max(50,textWidth+10)+"px";};updateInputWidth();input.addEventListener("input",updateInputWidth);setTimeout(()=>{input.focus();if(text)input.select();},10);activeInput=input;const finish=()=>{if(!activeInput)return;if(shapeIndex>=0&&shapeIndex<shapes.length){const shape=shapes[shapeIndex];shape.innerText=input.value;shape.innerTextSize=useSize;shape.innerTextColor=useColor;shape.isEditingText=false;clearSelection();selectedIndices.add(shapeIndex);setTool("select",true);saveHistory();render();}
cleanupInput();};input.addEventListener("keydown",(e)=>{if(e.key==="Enter")finish();});input.addEventListener("blur",finish);}
function handleEraser(pos){let erased=false;for(let i=shapes.length-1;i>=0;i--){if(isPointInShape(pos,shapes[i])){shapes.splice(i,1);erased=true;break;}}
if(erased){clearSelection();updateConnections();render();saveHistory();}}
function getHitHandle(pos,shape){const r=12/camera.scale;if(shape.type==="arrow"||shape.type==="line"){if(dist(pos,shape.start)<r)return"start";if(dist(pos,shape.end)<r)return"end";if(shape.type==="arrow"&&shape.control&&dist(pos,shape.control)<r)
return"control";if(shape.type==="line"){const midX=(shape.start.x+shape.end.x)/2;const midY=(shape.start.y+shape.end.y)/2;if(dist(pos,{x:midX,y:midY})<r)return"bend";}}else{let x,y,w,h;if(shape.type==="text"||shape.type==="pencil"||shape.type==="pencil-arrow"||shape.type==="image"){const b=getBoundingBox(shape);x=b.x;y=b.y;w=b.w;h=b.h;}else{x=shape.x;y=shape.y;w=shape.w;h=shape.h;}
if(dist(pos,{x:x,y:y})<r)return"tl";if(dist(pos,{x:x+w,y:y})<r)return"tr";if(dist(pos,{x:x,y:y+h})<r)return"bl";if(dist(pos,{x:x+w,y:y+h})<r)return"br";const sideR=8/camera.scale;if(Math.abs(pos.y-y)<sideR&&pos.x>x+r&&pos.x<x+w-r)return"top";if(Math.abs(pos.y-(y+h))<sideR&&pos.x>x+r&&pos.x<x+w-r)
return"bottom";if(Math.abs(pos.x-x)<sideR&&pos.y>y+r&&pos.y<y+h-r)return"left";if(Math.abs(pos.x-(x+w))<sideR&&pos.y>y+r&&pos.y<y+h-r)
return"right";}
return null;}
function bringToFront(){if(selectedIndices.size===0)return;const selectedShapes=[];const remainingShapes=[];shapes.forEach((s,i)=>{if(selectedIndices.has(i))selectedShapes.push(s);else remainingShapes.push(s);});shapes=[...remainingShapes,...selectedShapes];clearSelection();for(let i=shapes.length-selectedShapes.length;i<shapes.length;i++){addToSelection(i);}
saveHistory();render();showToast("Brought to Front");}
function sendToBack(){if(selectedIndices.size===0)return;const selectedShapes=[];const remainingShapes=[];shapes.forEach((s,i)=>{if(selectedIndices.has(i))selectedShapes.push(s);else remainingShapes.push(s);});shapes=[...selectedShapes,...remainingShapes];clearSelection();for(let i=0;i<selectedShapes.length;i++){addToSelection(i);}
saveHistory();render();showToast("Sent to Back");}
function isPointInShape(pos,shape,hitPaddingOverride=null){const basePadding=hitPaddingOverride!==null?hitPaddingOverride:3;const hitPadding=basePadding/camera.scale;const halfWidth=(shape.width||2)/2;const t=halfWidth+hitPadding;const isFilled=shape.fillColor&&shape.fillColor!=="transparent";if(shape.type==="rect"){const x=Math.min(shape.x,shape.x+shape.w);const y=Math.min(shape.y,shape.y+shape.h);const w=Math.abs(shape.w);const h=Math.abs(shape.h);const isInside=pos.x>=x&&pos.x<=x+w&&pos.y>=y&&pos.y<=y+h;if(isFilled&&isInside)return true;if(!isFilled){return isInside;}
return(pos.x>x-t&&pos.x<x+w+t&&pos.y>y-t&&pos.y<y+h+t&&!(pos.x>x+t&&pos.x<x+w-t&&pos.y>y+t&&pos.y<y+h-t));}else if(shape.type==="circle"){const cx=shape.x+shape.w/2;const cy=shape.y+shape.h/2;const rx=Math.abs(shape.w/2);const ry=Math.abs(shape.h/2);const normalizedX=(pos.x-cx)/rx;const normalizedY=(pos.y-cy)/ry;const distSq=normalizedX*normalizedX+normalizedY*normalizedY;if(isFilled&&distSq<=1.05)return true;if(!isFilled&&distSq<=1.0)return true;return Math.abs(Math.sqrt(distSq)-1)*Math.max(rx,ry)<t;}else if(shape.type==="triangle"){const x=Math.min(shape.x,shape.x+shape.w);const y=Math.min(shape.y,shape.y+shape.h);const w=Math.abs(shape.w);const h=Math.abs(shape.h);const p1={x:x+w/2,y:y};const p2={x:x+w,y:y+h};const p3={x:x,y:y+h};if(isFilled){const area=0.5*(-p2.y*p3.x+p1.y*(-p2.x+p3.x)+p1.x*(p2.y-p3.y)+p2.x*p3.y);const s=1/(2*area)*(p1.y*p3.x-p1.x*p3.y+(p3.y-p1.y)*pos.x+(p1.x-p3.x)*pos.y);const t_val=1/(2*area)*(p1.x*p2.y-p1.y*p2.x+(p1.y-p2.y)*pos.x+(p2.x-p1.x)*pos.y);return s>0&&t_val>0&&1-s-t_val>0;}
return(distToSegment(pos,p1,p2)<t||distToSegment(pos,p2,p3)<t||distToSegment(pos,p3,p1)<t);}else if(shape.type==="oval"){const w=Math.abs(shape.w);const h=Math.abs(shape.h);const radius=Math.min(w,h)/2;let x=shape.x;let y=shape.y;if(shape.w<0)x+=shape.w;if(shape.h<0)y+=shape.h;let dist=0;if(w>h){const segmentStart={x:x+radius,y:y+h/2};const segmentEnd={x:x+w-radius,y:y+h/2};dist=distToSegment(pos,segmentStart,segmentEnd);}else{const segmentStart={x:x+w/2,y:y+radius};const segmentEnd={x:x+w/2,y:y+h-radius};dist=distToSegment(pos,segmentStart,segmentEnd);}
return dist<=radius+(isFilled?0:t);}else if(shape.type==="rhombus"){const skew=Math.abs(shape.w)*0.1;const x=shape.x;const y=shape.y;const w=shape.w;const h=shape.h;const p1={x:x+skew,y:y};const p2={x:x+w,y:y};const p3={x:x+w-skew,y:y+h};const p4={x:x,y:y+h};const poly=[p1,p2,p3,p4];let inside=false;for(let i=0,j=poly.length-1;i<poly.length;j=i++){const xi=poly[i].x,yi=poly[i].y;const xj=poly[j].x,yj=poly[j].y;const intersect=yi>pos.y!==yj>pos.y&&pos.x<((xj-xi)*(pos.y-yi))/(yj-yi)+xi;if(intersect)inside=!inside;}
return inside;}else if(shape.type==="diamond"){const cx=shape.x+shape.w/2;const cy=shape.y+shape.h/2;const w=Math.abs(shape.w);const h=Math.abs(shape.h);return Math.abs(pos.x-cx)/(w/2)+Math.abs(pos.y-cy)/(h/2)<=1;}else if(shape.type==="text"){ctx.font=`bold ${shape.size}px'Caveat',cursive`;const m=ctx.measureText(shape.text);return(pos.x>=shape.x&&pos.x<=shape.x+m.width&&pos.y>=shape.y&&pos.y<=shape.y+shape.size);}else if(shape.type==="pencil"||shape.type==="pencil-arrow"){for(let i=0;i<shape.points.length-1;i++){if(distToSegment(pos,shape.points[i],shape.points[i+1])<t)return true;}
return false;}else if(shape.type==="line"){return distToSegment(pos,shape.start,shape.end)<t;}else if(shape.type==="arrow"){const cp=shape.control||{x:(shape.start.x+shape.end.x)/2,y:(shape.start.y+shape.end.y)/2,};let prev=shape.start;for(let i=1;i<=20;i++){const time=i/20;const mt=1-time;const x=mt*mt*shape.start.x+2*mt*time*cp.x+time*time*shape.end.x;const y=mt*mt*shape.start.y+2*mt*time*cp.y+time*time*shape.end.y;const curr={x,y};if(distToSegment(pos,prev,curr)<t)return true;prev=curr;}
return false;}else if(shape.type==="image"){const x=Math.min(shape.x,shape.x+shape.w);const y=Math.min(shape.y,shape.y+shape.h);const w=Math.abs(shape.w);const h=Math.abs(shape.h);return pos.x>x&&pos.x<x+w&&pos.y>y&&pos.y<y+h;}
return false;}
function dist(p1,p2){return Math.hypot(p1.x-p2.x,p1.y-p2.y);}
function distToSegment(p,v,w){const l2=(w.x-v.x)**2+(w.y-v.y)**2;if(l2===0)return dist(p,v);let t=((p.x-v.x)*(w.x-v.x)+(p.y-v.y)*(w.y-v.y))/l2;t=Math.max(0,Math.min(1,t));return Math.hypot(p.x-(v.x+t*(w.x-v.x)),p.y-(v.y+t*(w.y-v.y)));}
function getBoundingBox(shape){if(shape.points){let mx=Infinity,my=Infinity,Mx=-Infinity,My=-Infinity;shape.points.forEach((p)=>{mx=Math.min(mx,p.x);my=Math.min(my,p.y);Mx=Math.max(Mx,p.x);My=Math.max(My,p.y);});return{x:mx,y:my,w:Mx-mx,h:My-my};}
if(shape.type==="line"||shape.type==="arrow"){const mx=Math.min(shape.start.x,shape.end.x);const my=Math.min(shape.start.y,shape.end.y);const Mx=Math.max(shape.start.x,shape.end.x);const My=Math.max(shape.start.y,shape.end.y);return{x:mx,y:my,w:Mx-mx,h:My-my};}
if(shape.type==="text"){ctx.save();ctx.setTransform(1,0,0,1,0,0);ctx.font=`bold ${shape.size}px'Caveat',cursive`;const m=ctx.measureText(shape.text);ctx.restore();return{x:shape.x,y:shape.y,w:m.width,h:shape.size};}
const x=Math.min(shape.x,shape.x+shape.w);const y=Math.min(shape.y,shape.y+shape.h);const w=Math.abs(shape.w);const h=Math.abs(shape.h);return{x,y,w,h};}
function updateCursor(){if(currentTool==="select"){canvas.style.cursor="default";}else if(currentTool==="eraser"){canvas.style.cursor="cell";}else{canvas.style.cursor="crosshair";}}
function setTool(tool,keepSelection=false){hideShapeRecognitionPanel();currentTool=tool;document.querySelectorAll(".tool-btn").forEach((btn)=>btn.classList.remove("active"));document.querySelectorAll(".shape-dropdown-item").forEach((btn)=>btn.classList.remove("active"));const toolMap={select:"btn-select",pencil:"btn-pencil","pencil-arrow":"btn-pencil-arrow",laser:"btn-laser",eraser:"btn-eraser",line:"btn-line",arrow:"btn-arrow",text:"btn-text",rect:"btn-rect",circle:"btn-circle",triangle:"btn-triangle",oval:"btn-oval",rhombus:"btn-rhombus",diamond:"btn-diamond",};const btnId=toolMap[tool];if(btnId){const btn=document.getElementById(btnId);if(btn)btn.classList.add("active");}
if(tool==="oval"||tool==="rhombus"||tool==="diamond"){const moreBtn=document.getElementById("btn-more-shapes");if(moreBtn)moreBtn.classList.add("active");}
updateCursor();if(!keepSelection)clearSelection();currentShape=null;render();}
function toggleShapeDropdown(){const menu=document.getElementById("shape-dropdown-menu");if(menu){menu.classList.toggle("visible");}}
function hideShapeDropdown(){const menu=document.getElementById("shape-dropdown-menu");if(menu){menu.classList.remove("visible");}}
document.addEventListener("click",(e)=>{const dropdown=document.querySelector(".shape-dropdown");if(dropdown&&!dropdown.contains(e.target)){hideShapeDropdown();}});function checkAndSetPencilIfEmpty(){if(shapes.length===0){setTool("pencil");}}
function setCurrentStrokeColor(color){setColor(color,'stroke');const fillMap={'#000000':'#e5e7eb','#ef4444':'#fee2e2','#3b82f6':'#dbeafe','#22c55e':'#dcfce7'};if(fillMap[color]){setColor(fillMap[color],'fill');}}
function setCurrentFillColor(color){setColor(color,'fill');}
function setColor(color,type){if(selectedIndices.size>0){selectedIndices.forEach((idx)=>{const shape=shapes[idx];if(type==='fill'){if(color==="transparent"&&shape.color==="transparent"){return;}
shape.fillColor=color;if(shape.type==="rect"||shape.type==="circle"||shape.type==="triangle"||shape.type==="oval"||shape.type==="rhombus"||shape.type==="diamond"){if(color==="transparent"){shape.innerTextColor="#000000";}else{const isLight=isColorLight(color);shape.innerTextColor=isLight?"#000000":"#ffffff";}}}else{if(color==="transparent"&&shape.fillColor==="transparent"){return;}
shape.color=color;}});showToast("Applied "+(type==="fill"?"Fill":"Stroke")+" color to selection");saveHistory();render();}else{if(type==='fill'){if(color==="transparent"&&currentColor==="transparent"){showToast("At least one color must be visible");return;}
currentFillColor=color;showToast("Default Fill color set to "+color);}else{if(color==="transparent"&&currentFillColor==="transparent"){showToast("At least one color must be visible");return;}
currentColor=color;showToast("Default Stroke color set to "+color);}}}
function isColorLight(color){if(color==="transparent")return false;let r,g,b;if(color.startsWith("#")){r=parseInt(color.slice(1,3),16);g=parseInt(color.slice(3,5),16);b=parseInt(color.slice(5,7),16);}else if(color.startsWith("rgb")){const matches=color.match(/\d+/g);r=parseInt(matches[0]);g=parseInt(matches[1]);b=parseInt(matches[2]);}else{return false;}
const luminance=(0.299*r+0.587*g+0.114*b)/255;return luminance>0.5;}
function updateColorUI(){}
function showContextMenu(x,y){const menu=document.getElementById("context-menu");menu.style.visibility="hidden";menu.classList.remove("hidden");const width=menu.offsetWidth;const height=menu.offsetHeight;const winWidth=window.innerWidth;const winHeight=window.innerHeight;if(x+width>winWidth){x=winWidth-width-10;}
if(y+height>winHeight){y=winHeight-height-10;}
x=Math.max(10,x);y=Math.max(10,y);menu.style.left=x+"px";menu.style.top=y+"px";menu.style.visibility="visible";}
function hideContextMenu(){document.getElementById("context-menu").classList.add("hidden");}
window.addEventListener("contextmenu",(e)=>{if(e.target!==canvas&&!canvas.contains(e.target)){return;}
const screenPos=getPointerPos(e);const pos=toWorld(screenPos.x,screenPos.y);let hitIndex=-1;for(let i=shapes.length-1;i>=0;i--){if(isPointInShape(pos,shapes[i],10)){hitIndex=i;break;}}
e.preventDefault();const pasteItem=document.getElementById("paste-menu-item");const pasteSeparator=document.getElementById("paste-separator");const toDottedItem=document.getElementById("to-dotted-line-item");const toggleStartArrowItem=document.getElementById("toggle-start-arrow-item");const toggleEndArrowItem=document.getElementById("toggle-end-arrow-item");const arrowTogglesContainer=document.getElementById("arrow-toggles-container");const editingLayeringSeparator=document.getElementById("editing-layering-separator");const layeringActionsContainer=document.getElementById("layering-actions-container");const bringToFront=document.getElementById("bring-to-front-item");const sendToBack=document.getElementById("send-to-back-item");const layeringDeleteSeparator=document.getElementById("layering-delete-separator");const duplicateItem=document.getElementById("duplicate-item");const deleteItem=document.getElementById("delete-item");const shapeConversionSeparator=document.getElementById("shape-conversion-separator");const changeToRectangleItem=document.getElementById("change-to-rectangle-item");const changeToCircleItem=document.getElementById("change-to-circle-item");const changeToTriangleItem=document.getElementById("change-to-triangle-item");const changeToOvalItem=document.getElementById("change-to-oval-item");const changeToRhombusItem=document.getElementById("change-to-rhombus-item");const changeToDiamondItem=document.getElementById("change-to-diamond-item");if(hitIndex!==-1){pasteItem.style.display="none";pasteSeparator.style.display="none";const hitShape=shapes[hitIndex];if(toDottedItem){if(hitShape&&hitShape.type!=="text"&&hitShape.type!=="image"){toDottedItem.style.display="flex";}else{toDottedItem.style.display="none";}}
if(arrowTogglesContainer){if(hitShape&&(hitShape.type==="line"||hitShape.type==="arrow"||hitShape.type==="pencil"||hitShape.type==="pencil-arrow")){arrowTogglesContainer.style.display="block";}else{arrowTogglesContainer.style.display="none";}}
if(editingLayeringSeparator)editingLayeringSeparator.style.display="block";if(layeringActionsContainer)layeringActionsContainer.style.display="block";if(layeringDeleteSeparator)layeringDeleteSeparator.style.display="block";if(duplicateItem)duplicateItem.style.display="flex";if(deleteItem)deleteItem.style.display="flex";const convertibleTypes=["rect","circle","triangle","oval","rhombus","diamond"];if(hitShape&&convertibleTypes.includes(hitShape.type)){if(shapeConversionSeparator)shapeConversionSeparator.style.display="block";if(changeToRectangleItem)changeToRectangleItem.style.display="flex";if(changeToCircleItem)changeToCircleItem.style.display="flex";if(changeToTriangleItem)changeToTriangleItem.style.display="flex";if(changeToOvalItem)changeToOvalItem.style.display="flex";if(changeToRhombusItem)changeToRhombusItem.style.display="flex";if(changeToDiamondItem)changeToDiamondItem.style.display="flex";}else{if(shapeConversionSeparator)shapeConversionSeparator.style.display="none";if(changeToRectangleItem)changeToRectangleItem.style.display="none";if(changeToCircleItem)changeToCircleItem.style.display="none";if(changeToTriangleItem)changeToTriangleItem.style.display="none";if(changeToOvalItem)changeToOvalItem.style.display="none";if(changeToRhombusItem)changeToRhombusItem.style.display="none";if(changeToDiamondItem)changeToDiamondItem.style.display="none";}
if(!selectedIndices.has(hitIndex)){clearSelection();selectedIndices.add(hitIndex);render();}
setTool("select",true);}else{pasteItem.style.display="flex";pasteSeparator.style.display="block";if(toDottedItem)toDottedItem.style.display="none";if(arrowTogglesContainer)arrowTogglesContainer.style.display="none";if(editingLayeringSeparator)editingLayeringSeparator.style.display="none";if(layeringActionsContainer)layeringActionsContainer.style.display="none";if(layeringDeleteSeparator)layeringDeleteSeparator.style.display="none";if(deleteItem)deleteItem.style.display="none";if(shapeConversionSeparator)shapeConversionSeparator.style.display="none";if(changeToRectangleItem)changeToRectangleItem.style.display="none";if(changeToCircleItem)changeToCircleItem.style.display="none";if(changeToTriangleItem)changeToTriangleItem.style.display="none";if(changeToOvalItem)changeToOvalItem.style.display="none";if(changeToRhombusItem)changeToRhombusItem.style.display="none";if(changeToDiamondItem)changeToDiamondItem.style.display="none";}
showContextMenu(e.clientX,e.clientY);});window.addEventListener("click",()=>{hideContextMenu();});function setCustomColor(color){setColor(color);const swatch=document.createElement("button");swatch.className="color-swatch w-5 h-5 rounded-full";swatch.style.backgroundColor=color;swatch.dataset.color=color;swatch.onclick=function(){setColor(color,this);};}
function setLineWidth(width){currentWidth=parseInt(width);const widthValDesk=document.getElementById("width-val-desk");const widthValMob=document.getElementById("width-val-mob");const widthSliderDesk=document.getElementById("width-slider-desk");const widthSliderMob=document.getElementById("width-slider-mob");if(widthValDesk)widthValDesk.textContent=currentWidth;if(widthValMob)widthValMob.textContent=currentWidth;if(widthSliderDesk)widthSliderDesk.value=currentWidth;if(widthSliderMob)widthSliderMob.value=currentWidth;}
function duplicateSelected(){if(selectedIndices.size===0)return;const duplicatedShapes=[];const offset=20/camera.scale;selectedIndices.forEach((idx)=>{const original=shapes[idx];const duplicate=JSON.parse(JSON.stringify(original,(key,value)=>{if(key==="image")return undefined;return value;}));duplicate.id=generateId();if(duplicate.points){duplicate.points=duplicate.points.map((p)=>({x:p.x+offset,y:p.y+offset,}));}else if(duplicate.start&&duplicate.end){duplicate.start.x+=offset;duplicate.start.y+=offset;duplicate.end.x+=offset;duplicate.end.y+=offset;if(duplicate.control){duplicate.control.x+=offset;duplicate.control.y+=offset;}}else{duplicate.x+=offset;duplicate.y+=offset;}
if(original.type==="image"&&original.src){const img=new Image();img.src=original.src;duplicate.image=img;}
duplicatedShapes.push(duplicate);});shapes.push(...duplicatedShapes);clearSelection();for(let i=shapes.length-duplicatedShapes.length;i<shapes.length;i++){addToSelection(i);}
saveHistory();render();showToast("Duplicated");}
function deleteSelected(){if(selectedIndices.size===0)return;const sortedIndices=Array.from(selectedIndices).sort((a,b)=>b-a);sortedIndices.forEach((idx)=>{shapes.splice(idx,1);});clearSelection();updateConnections();saveHistory();render();showToast("Deleted");checkAndSetPencilIfEmpty();}
function toggleDottedLine(){if(selectedIndices.size===0)return;selectedIndices.forEach((idx)=>{if(shapes[idx]){shapes[idx].isDotted=!shapes[idx].isDotted;}});saveHistory();render();showToast(shapes[Array.from(selectedIndices)[0]].isDotted?"To Dotted":"To Solid");}
function toggleStartArrow(){if(selectedIndices.size===0)return;selectedIndices.forEach((idx)=>{const shape=shapes[idx];if(shape&&(shape.type==="line"||shape.type==="arrow"||shape.type==="pencil"||shape.type==="pencil-arrow")){if(shape.hasStartArrow===undefined){shape.hasStartArrow=false;}
shape.hasStartArrow=!shape.hasStartArrow;}});saveHistory();render();showToast(shapes[Array.from(selectedIndices)[0]].hasStartArrow?"Start Arrow Added":"Start Arrow Removed");}
function toggleEndArrow(){if(selectedIndices.size===0)return;selectedIndices.forEach((idx)=>{const shape=shapes[idx];if(shape&&(shape.type==="line"||shape.type==="arrow"||shape.type==="pencil"||shape.type==="pencil-arrow")){if(shape.hasEndArrow===undefined){if(shape.type==="pencil-arrow"||shape.type==="arrow"){shape.hasEndArrow=true;}else{shape.hasEndArrow=false;}}
shape.hasEndArrow=!shape.hasEndArrow;}});saveHistory();render();showToast(shapes[Array.from(selectedIndices)[0]].hasEndArrow?"End Arrow Added":"End Arrow Removed");}
function clearBoard(){shapes=[];clearSelection();currentShape=null;camera.x=0;camera.y=0;camera.scale=1;saveHistory();render();showToast("Board Cleared");checkAndSetPencilIfEmpty();}
function resetView(){camera.x=0;camera.y=0;camera.scale=1;render();showToast("View Reset");}
function downloadImage(){const link=document.createElement("a");link.download="scribble-"+Date.now()+".png";link.href=canvas.toDataURL();link.click();showToast("Image Downloaded");}
function showToast(message){if(toastEl){toastEl.textContent=message;toastEl.classList.remove("opacity-0");setTimeout(()=>{toastEl.classList.add("opacity-0");},2000);}}
function showShapeRecognitionPanel(originalShape,convertedIndex){const panel=document.getElementById("shape-recognition-panel");if(!panel)return;originalPencilShape=JSON.parse(JSON.stringify(originalShape));convertedShapeIndex=convertedIndex;if(shapeRecognitionPanelTimer){clearTimeout(shapeRecognitionPanelTimer);shapeRecognitionPanelTimer=null;}
panel.classList.remove("hidden");setTimeout(()=>{panel.style.opacity="1";panel.style.transform="translate(-50%, 0)";},10);shapeRecognitionPanelTimer=setTimeout(()=>{hideShapeRecognitionPanel();},4000);}
function hideShapeRecognitionPanel(){const panel=document.getElementById("shape-recognition-panel");if(!panel)return;if(shapeRecognitionPanelTimer){clearTimeout(shapeRecognitionPanelTimer);shapeRecognitionPanelTimer=null;}
panel.style.opacity="0";panel.style.transform="translate(-50%, -10px)";setTimeout(()=>{panel.classList.add("hidden");originalPencilShape=null;convertedShapeIndex=-1;},300);}
function undoShapeRecognition(){if(originalPencilShape===null||convertedShapeIndex===-1){hideShapeRecognitionPanel();return;}
if(shapes[convertedShapeIndex]){shapes.splice(convertedShapeIndex,1);}
shapes.push(originalPencilShape);clearSelection();addToSelection(shapes.length-1);saveHistory();render();hideShapeRecognitionPanel();showToast("Reverted to original drawing");}
function convertToShape(shapeType){if(originalPencilShape===null||convertedShapeIndex===-1){hideShapeRecognitionPanel();return;}
if(shapes[convertedShapeIndex]){shapes.splice(convertedShapeIndex,1);}
const detectedShape={type:shapeType};const newShape=convertPencilToShape(originalPencilShape,detectedShape);shapes.push(newShape);convertedShapeIndex=shapes.length-1;clearSelection();addToSelection(convertedShapeIndex);saveHistory();render();const shapeNameMap={rectangle:"Rectangle",circle:"Circle",triangle:"Triangle",};const shapeName=shapeNameMap[shapeType]||shapeType;showToast(`Converted to ${shapeName}`);if(shapeRecognitionPanelTimer){clearTimeout(shapeRecognitionPanelTimer);}
shapeRecognitionPanelTimer=setTimeout(()=>{hideShapeRecognitionPanel();},4000);}
function changeSelectedShapesType(targetType){if(!selectedIndices||selectedIndices.size===0)return;selectedIndices.forEach((idx)=>{const shape=shapes[idx];if(!shape)return;if(shape.type==="rect"||shape.type==="circle"||shape.type==="triangle"||shape.type==="oval"||shape.type==="rhombus"||shape.type==="diamond"){shape.type=targetType;}else if(shape.type==="pencil"&&Array.isArray(shape.points)&&shape.points.length>1){const detectedShape={type:targetType==="rect"?"rectangle":targetType,};const newShape=convertPencilToShape(shape,detectedShape);newShape.fillColor=shape.fillColor||"transparent";newShape.innerText=shape.innerText||"";newShape.innerTextColor=shape.innerTextColor||"#000000";newShape.innerTextSize=shape.innerTextSize||20;shapes[idx]=newShape;}});saveHistory();render();}
function handleImageFile(file){if(!file||!file.type.startsWith("image/"))return;const reader=new FileReader();reader.onload=(e)=>{const img=new Image();img.onload=()=>{let w=img.width;let h=img.height;const maxDim=400;if(w>maxDim||h>maxDim){const ratio=Math.min(maxDim/w,maxDim/h);w*=ratio;h*=ratio;}
const worldCenter=toWorld(canvas.width/2,canvas.height/2);const newShape={id:generateId(),type:"image",x:worldCenter.x-w/2,y:worldCenter.y-h/2,w:w,h:h,image:img,src:e.target.result,aspectRatio:w/h,};shapes.push(newShape);clearSelection();addToSelection(shapes.length-1);setTool("select",true);saveHistory();render();showToast("Image Added");};img.src=e.target.result;};reader.readAsDataURL(file);}
function pasteFromClipboard(){navigator.clipboard.read().then((items)=>{for(const item of items){if(item.types.some((type)=>type.startsWith("image/"))){item.getType(item.types.find((t)=>t.startsWith("image/"))).then((blob)=>{handleImageFile(blob);});return;}}
showToast("No image found in clipboard");}).catch((err)=>{showToast("Clipboard access denied or no image in clipboard");console.error("Clipboard error:",err);});}
window.addEventListener("dragover",(e)=>{e.preventDefault();e.dataTransfer.dropEffect="copy";});window.addEventListener("drop",(e)=>{e.preventDefault();if(e.dataTransfer.files&&e.dataTransfer.files[0]){handleImageFile(e.dataTransfer.files[0]);}});window.addEventListener("paste",(e)=>{const items=(e.clipboardData||e.originalEvent.clipboardData).items;for(const item of items){if(item.type.indexOf("image")!==-1){const file=item.getAsFile();handleImageFile(file);}}});const STORAGE_KEY="scribble_canvas_v1";function saveToLocalStorage(){const data={shapes:shapes,camera:camera,};try{const json=JSON.stringify(data,(key,value)=>{if(key==="image")return undefined;return value;});localStorage.setItem(STORAGE_KEY,json);}catch(e){console.error("Failed to save to local storage",e);}}
function loadFromLocalStorage(){try{const json=localStorage.getItem(STORAGE_KEY);if(!json)return false;const data=JSON.parse(json);if(data.shapes){shapes=data.shapes.map((s)=>{if(s.type==="image"&&s.src){const img=new Image();img.src=s.src;return{...s,image:img};}
return s;});}
if(data.camera){if(typeof data.camera.x==="number"&&typeof data.camera.y==="number"&&typeof data.camera.scale==="number"){camera=data.camera;}}
return true;}catch(e){console.error("Failed to load from local storage",e);return false;}}
function saveHistory(){const s=JSON.stringify(shapes,(key,value)=>{if(key==="image")return undefined;return value;});if(historyStack.length>0&&historyStack[historyStep]===s)return;if(historyStep<historyStack.length-1){historyStack=historyStack.slice(0,historyStep+1);}
historyStack.push(s);if(historyStack.length>MAX_HISTORY)historyStack.shift();else historyStep++;saveToLocalStorage();}
function undo(){if(historyStep>0){historyStep--;const savedShapes=JSON.parse(historyStack[historyStep]);shapes=savedShapes.map((s)=>{if(s.type==="image"&&s.src){const img=new Image();img.src=s.src;return{...s,image:img};}
return s;});const validSelection=new Set();selectedIndices.forEach((idx)=>{if(idx<shapes.length){validSelection.add(idx);}});selectedIndices=validSelection;selectionQueue=Array.from(validSelection);updateConnections();render();showToast("Undo");checkAndSetPencilIfEmpty();}else if(historyStep===0){historyStep=-1;shapes=[];clearSelection();render();showToast("Undo");checkAndSetPencilIfEmpty();}}
function isPointInsideShapeBounds(pos,shape){if(shape.type==="rect"){const x=Math.min(shape.x,shape.x+shape.w);const y=Math.min(shape.y,shape.y+shape.h);const w=Math.abs(shape.w);const h=Math.abs(shape.h);return pos.x>=x&&pos.x<=x+w&&pos.y>=y&&pos.y<=y+h;}else if(shape.type==="circle"){const cx=shape.x+shape.w/2;const cy=shape.y+shape.h/2;const rx=Math.abs(shape.w/2);const ry=Math.abs(shape.h/2);const normalizedX=(pos.x-cx)/rx;const normalizedY=(pos.y-cy)/ry;const distSq=normalizedX*normalizedX+normalizedY*normalizedY;return distSq<=1.05;}else if(shape.type==="triangle"){const x=Math.min(shape.x,shape.x+shape.w);const y=Math.min(shape.y,shape.y+shape.h);const w=Math.abs(shape.w);const h=Math.abs(shape.h);return pos.x>=x&&pos.x<=x+w&&pos.y>=y&&pos.y<=y+h;}else if(shape.type==="oval"){const cx=shape.x+shape.w/2;const cy=shape.y+shape.h/2;const rx=Math.abs(shape.w/2);const ry=Math.abs(shape.h/2);const normalizedX=(pos.x-cx)/rx;const normalizedY=(pos.y-cy)/ry;const distSq=normalizedX*normalizedX+normalizedY*normalizedY;return distSq<=1.05;}else if(shape.type==="rhombus"||shape.type==="diamond"){const x=Math.min(shape.x,shape.x+shape.w);const y=Math.min(shape.y,shape.y+shape.h);const w=Math.abs(shape.w);const h=Math.abs(shape.h);return pos.x>=x&&pos.x<=x+w&&pos.y>=y&&pos.y<=y+h;}else if(shape.type==="text"){ctx.font=`bold ${shape.size}px'Caveat',cursive`;const m=ctx.measureText(shape.text);return(pos.x>=shape.x&&pos.x<=shape.x+m.width&&pos.y>=shape.y&&pos.y<=shape.y+shape.size);}
return false;}
function onDoubleClick(e){const screenPos=getPointerPos(e);const pos=toWorld(screenPos.x,screenPos.y);for(let i=shapes.length-1;i>=0;i--){const shape=shapes[i];if(shape.type==="rect"||shape.type==="circle"||shape.type==="triangle"||shape.type==="oval"||shape.type==="rhombus"||shape.type==="diamond"){if(isPointInsideShapeBounds(pos,shape)){const centerX=shape.x+shape.w/2;const centerY=shape.y+shape.h/2;const existingText=shape.innerText||"";const textSize=shape.innerTextSize||currentWidth*5+10;const textColor=shape.innerTextColor||currentColor;const shapeIndex=i;createTextInputForShape(centerX,centerY,existingText,textSize,textColor,shapeIndex);return;}}else if(isPointInShape(pos,shape)){if(shape.type==="text"){shapes.splice(i,1);clearSelection();render();createTextInput(shape.x,shape.y,shape.text,shape.size,shape.color);return;}}}}
document.addEventListener("keydown",(e)=>{if(isTyping)return;const isCtrl=e.ctrlKey||e.metaKey;const isAlt=e.altKey;const k=e.key.toLowerCase();if(isCtrl&&k==="z"){e.preventDefault();undo();}else if(isAlt&&k==="n"){e.preventDefault();clearBoard();}else if(isCtrl&&k==="a"){e.preventDefault();clearSelection();shapes.forEach((_,i)=>addToSelection(i));setTool("select",true);render();showToast(`Selected ${shapes.length}object${shapes.length!==1?"s":""}`);}else if(e.key==="Escape"){setTool("select");if(selectedIndices.size>0){clearSelection();render();showToast("Selection Removed");}else{resetView();}
e.preventDefault();}else if(isCtrl&&["arrowup","arrowright","arrowdown","arrowleft"].includes(k)){e.preventDefault();const sideMap={arrowup:"top",arrowright:"right",arrowdown:"bottom",arrowleft:"left",};createLinkedShapeOnSide(sideMap[k]);}else if(!isCtrl&&!isAlt&&selectedIndices.size>1&&["l","r","t","b","c","v","h","e"].includes(k)){e.preventDefault();if(k==="l")alignSelected("left");else if(k==="r")alignSelected("right");else if(k==="t")alignSelected("top");else if(k==="b")alignSelected("bottom");else if(k==="h"||k==="e")
alignSelected("center-h");else if(k==="c"||k==="v")alignSelected("middle-v");showToast("Aligned "+k.toUpperCase());}else if(isCtrl&&k==="k"){e.preventDefault();setCurrentStrokeColor("#000000");}else if(isCtrl&&k==="r"){e.preventDefault();setCurrentStrokeColor("#ef4444");}else if(isCtrl&&k==="g"){e.preventDefault();setCurrentStrokeColor("#22c55e");}else if(isCtrl&&k==="b"){e.preventDefault();setCurrentStrokeColor("#3b82f6");}else if(isCtrl&&k==="d"){e.preventDefault();duplicateSelected();}else if(e.key==="Delete"||e.key==="Backspace"){deleteSelected();}else if(e.key==="[")setLineWidth(Math.max(1,currentWidth-1));else if(e.key==="]")setLineWidth(Math.min(50,currentWidth+1));else if(!isCtrl&&!isAlt&&k==="s")setTool("select");else if(!isCtrl&&!isAlt&&k==="e")setTool("eraser");else if(!isCtrl&&!isAlt&&k==="p")setTool("pencil");else if(!isCtrl&&!isAlt&&k==="f")setTool("pencil-arrow");else if(!isCtrl&&!isAlt&&k==="z")setTool("laser");else if(!isCtrl&&!isAlt&&k==="l")setTool("line");else if(!isCtrl&&!isAlt&&k==="a")setTool("arrow");else if(!isCtrl&&!isAlt&&k==="r")setTool("rect");else if(!isCtrl&&!isAlt&&k==="t")setTool("text");else if(!isCtrl&&!isAlt&&k==="n")setTool("triangle");else if(!isCtrl&&!isAlt&&k==="c")setTool("circle");});canvas.addEventListener("mousedown",onMouseDown);canvas.addEventListener("mousemove",onMouseMove);window.addEventListener("mouseup",onMouseUp);canvas.addEventListener("touchstart",onMouseDown,{passive:false});canvas.addEventListener("touchmove",onMouseMove,{passive:false});window.addEventListener("touchend",onMouseUp);canvas.addEventListener("dblclick",onDoubleClick);resizeCanvas();if(loadFromLocalStorage()){render();saveHistory();}else{saveHistory();}
window.setTool=setTool;window.setLineWidth=setLineWidth;window.undo=undo;window.duplicateSelected=duplicateSelected;window.deleteSelected=deleteSelected;window.clearBoard=clearBoard;window.downloadImage=downloadImage;window.alignSelected=alignSelected;window.resetView=resetView;window.handleImageFile=handleImageFile;window.setCurrentStrokeColor=setCurrentStrokeColor;window.setCurrentFillColor=setCurrentFillColor;window.bringToFront=bringToFront;window.sendToBack=sendToBack;window.undoShapeRecognition=undoShapeRecognition;window.convertToShape=convertToShape;window.pasteFromClipboard=pasteFromClipboard;window.toggleDottedLine=toggleDottedLine;window.setColor=setColor;window.hideContextMenu=hideContextMenu;window.toggleShapeDropdown=toggleShapeDropdown;window.hideShapeDropdown=hideShapeDropdown;window.changeSelectedShapesType=changeSelectedShapesType;updateColorUI();</script>
</body>
</html>